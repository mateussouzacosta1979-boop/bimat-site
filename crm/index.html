<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BIMAT CRM | Sistema de Gest√£o</title>
<meta name="theme-color" content="#0B3D6B"/>
<link rel="icon" type="image/png" href="icone.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
:root{--navy:#0B3D6B;--navy-dark:#082E52;--navy-deep:#061E38;--navy-bg:#EEF4FB;--gold:#C9A84C;--gold-lt:#E5C97A;--gold-bg:#FBF7EE;--cream:#F7F4EF;--white:#FFFFFF;--text:#1C2A3A;--muted:#5A6A7A;--border:#E2E8F0;--green:#0D9B5A;--green-bg:#ECFDF5;--red:#DC2626;--red-bg:#FEF2F2;--amber:#D97706;--amber-bg:#FFFBEB;--purple:#7C3AED;--purple-bg:#F5F3FF;--sidebar-w:260px;--topbar-h:64px;--r-sm:8px;--r-md:12px;--r-lg:16px;--r-xl:24px;--sh-sm:0 1px 3px rgba(11,61,107,.08),0 1px 2px rgba(11,61,107,.06);--sh-md:0 4px 16px rgba(11,61,107,.10);--sh-lg:0 8px 32px rgba(11,61,107,.14);--sh-xl:0 16px 48px rgba(11,61,107,.18);}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px;scroll-behavior:smooth}
body{font-family:'Outfit',sans-serif;color:var(--text);background:var(--cream);line-height:1.6;overflow-x:hidden;-webkit-font-smoothing:antialiased}
h1,h2,h3,h4,h5{font-family:'Cormorant Garamond',serif;line-height:1.2}
a{color:inherit;text-decoration:none}
input,select,textarea,button{font-family:'Outfit',sans-serif;font-size:14px}
button{cursor:pointer}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

#app{display:none;height:100vh;overflow:hidden}
#login-page{display:flex;align-items:stretch;height:100vh;background:linear-gradient(135deg,var(--navy-deep) 0%,var(--navy) 60%,#1a5a9e 100%);position:relative;overflow:hidden}
#login-page.active{display:flex;align-items:stretch}
.login-orb{position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,.18) 0%,transparent 70%);top:-100px;left:-100px;pointer-events:none}
.login-left{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 48px;color:white;position:relative;z-index:1}
.login-logo{display:flex;align-items:center;gap:16px;margin-bottom:48px}
.login-logo-mark{width:64px;height:64px;background:rgba(255,255,255,.08);border:2px solid rgba(201,168,76,.3);border-radius:16px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.login-logo-txt .name{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:white}
.login-logo-txt .sub{font-size:11px;font-weight:600;color:var(--gold-lt);letter-spacing:1.5px;text-transform:uppercase}
.login-headline{font-family:'Cormorant Garamond',serif;font-size:44px;font-weight:700;line-height:1.1;color:white;text-align:center;margin-bottom:20px}
.login-headline span{color:var(--gold-lt)}
.login-mission{font-size:16px;color:rgba(255,255,255,.72);text-align:center;max-width:420px;line-height:1.7;margin-bottom:40px}
.login-stats{display:flex;gap:32px}
.login-stat{text-align:center}
.login-stat .num{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--gold-lt)}
.login-stat .lbl{font-size:12px;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px}
.login-divider{width:1px;background:rgba(255,255,255,.15)}
.login-right{width:460px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.04);backdrop-filter:blur(20px);border-left:1px solid rgba(255,255,255,.1);padding:48px}
.login-card{background:white;border-radius:var(--r-xl);padding:40px;width:100%;max-width:380px;box-shadow:var(--sh-xl)}
.login-card-header{margin-bottom:32px;text-align:center}
.login-card-header h2{font-size:26px;color:var(--navy);margin-bottom:6px}
.login-card-header p{font-size:13px;color:var(--muted)}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:14px;color:var(--text);background:white;transition:all .2s;outline:none}
.form-input:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(11,61,107,.08)}
.form-input::placeholder{color:#b0bec5}
.btn-primary{width:100%;padding:13px 24px;background:var(--navy);color:white;border:none;border-radius:var(--r-sm);font-size:15px;font-weight:600;cursor:pointer;transition:all .25s}
.btn-primary:hover{background:var(--navy-dark);transform:translateY(-1px);box-shadow:0 6px 20px rgba(11,61,107,.3)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
.login-forgot{display:block;text-align:center;font-size:13px;color:var(--navy);margin-top:14px;font-weight:500;cursor:pointer}
.login-forgot:hover{text-decoration:underline}
.login-error{background:var(--red-bg);border:1px solid rgba(220,38,38,.2);border-radius:var(--r-sm);padding:10px 14px;font-size:13px;color:var(--red);margin-bottom:18px;display:none}
.login-error.show{display:block}

#sidebar{width:var(--sidebar-w);height:100vh;background:var(--navy-deep);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;transition:width .3s;position:relative;z-index:100}
#sidebar.collapsed{width:64px}
.sidebar-logo{padding:0 20px;height:var(--topbar-h);display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.08);flex-shrink:0}
.sidebar-logo-mark{width:36px;height:36px;background:rgba(255,255,255,.08);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}
.sidebar-logo-txt{overflow:hidden;white-space:nowrap}
.sidebar-logo-name{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:white}
.sidebar-logo-sub{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:.8px;text-transform:uppercase}
.sidebar-nav{flex:1;overflow-y:auto;padding:12px 0;overflow-x:hidden}
.nav-section-label{padding:8px 20px 4px;font-size:10px;font-weight:700;color:rgba(255,255,255,.3);letter-spacing:1.2px;text-transform:uppercase;white-space:nowrap;overflow:hidden}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 20px;color:rgba(255,255,255,.6);font-size:13.5px;font-weight:500;cursor:pointer;transition:all .15s;position:relative;white-space:nowrap;margin:1px 0}
.nav-item:hover{color:white;background:rgba(255,255,255,.07)}
.nav-item.active{color:white;background:rgba(201,168,76,.15)}
.nav-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--gold);border-radius:0 3px 3px 0}
.nav-item svg{flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.nav-item-label{overflow:hidden;white-space:nowrap}
.nav-badge{margin-left:auto;background:var(--red);color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:12px;flex-shrink:0;white-space:nowrap;overflow:hidden;position:relative}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--gold));display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:13px;flex-shrink:0}
.user-info{overflow:hidden}
.user-name{font-size:13px;font-weight:600;color:white;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-role{font-size:11px;color:rgba(255,255,255,.45)}
.sidebar-collapse-btn{width:28px;height:28px;background:rgba(255,255,255,.08);border:none;border-radius:6px;color:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:auto;flex-shrink:0;transition:all .2s}
.sidebar-collapse-btn:hover{background:rgba(255,255,255,.15);color:white}

#main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{height:var(--topbar-h);background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:16px;flex-shrink:0;box-shadow:0 1px 0 rgba(11,61,107,.06);position:relative;z-index:50}
#topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--navy) 0%,var(--gold) 50%,var(--navy) 100%);opacity:.25}
.topbar-breadcrumb{font-size:12px;color:var(--muted)}
.topbar-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--navy);margin-right:auto}
.global-search{position:relative;width:280px}
.global-search input{width:100%;padding:9px 14px 9px 36px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:13px;background:var(--cream);outline:none;transition:all .2s;color:var(--text)}
.global-search input:focus{border-color:var(--navy);background:white}
.global-search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted)}
.topbar-actions{display:flex;align-items:center;gap:8px}
.topbar-btn{width:36px;height:36px;border:1.5px solid var(--border);border-radius:var(--r-sm);background:white;display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;transition:all .2s;position:relative}
.topbar-btn:hover{border-color:var(--navy);color:var(--navy);background:var(--navy-bg)}
.notif-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid white}

#content{flex:1;overflow-y:auto;padding:28px;background:var(--cream)}
.content-section{display:none}
.content-section.active{display:block}

.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.page-header-left h1{font-size:28px;color:var(--navy);font-weight:700}
.page-header-left p{font-size:13px;color:var(--muted);margin-top:2px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:9px 18px;font-size:13.5px;font-weight:600;border-radius:var(--r-sm);cursor:pointer;transition:all .2s;border:none;letter-spacing:.2px}
.btn-sm{padding:7px 14px;font-size:13px}
.btn-navy{background:var(--navy);color:white}
.btn-navy:hover{background:var(--navy-dark);transform:translateY(-1px);box-shadow:0 4px 16px rgba(11,61,107,.3)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-lt));color:var(--navy-deep)}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(201,168,76,.4)}
.btn-outline{background:white;color:var(--navy);border:1.5px solid var(--border)}
.btn-outline:hover{border-color:var(--navy);background:var(--navy-bg)}
.btn-ghost{background:transparent;color:var(--muted)}
.btn-ghost:hover{color:var(--navy);background:var(--navy-bg)}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(220,38,38,.2)}
.btn-danger:hover{background:var(--red);color:white}
.btn-success{background:var(--green-bg);color:var(--green);border:1px solid rgba(13,155,90,.2)}
.btn-success:hover{background:var(--green);color:white}

.card{background:white;border-radius:var(--r-lg);border:1px solid var(--border);box-shadow:var(--sh-sm);overflow:hidden}
.card-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h3{font-size:16px;font-weight:700;color:var(--navy)}
.card-body{padding:22px}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:24px}
.stat-card{background:white;border-radius:var(--r-lg);padding:22px;border:1px solid var(--border);box-shadow:var(--sh-sm);position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;top:0;right:0;width:4px;height:100%;border-radius:0 var(--r-lg) var(--r-lg) 0}
.stat-card.navy::after{background:var(--navy)}.stat-card.gold::after{background:var(--gold)}.stat-card.green::after{background:var(--green)}.stat-card.red::after{background:var(--red)}.stat-card.purple::after{background:var(--purple)}.stat-card.amber::after{background:var(--amber)}
.stat-icon{width:44px;height:44px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.stat-icon.navy{background:var(--navy-bg);color:var(--navy)}.stat-icon.gold{background:var(--gold-bg);color:var(--gold)}.stat-icon.green{background:var(--green-bg);color:var(--green)}.stat-icon.red{background:var(--red-bg);color:var(--red)}.stat-icon.purple{background:var(--purple-bg);color:var(--purple)}.stat-icon.amber{background:var(--amber-bg);color:var(--amber)}
.stat-value{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:var(--navy);line-height:1;margin-bottom:6px}
.stat-label{font-size:13px;color:var(--muted);font-weight:500}
.stat-change{font-size:12px;margin-top:6px}

.badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.6}
.badge-navy{background:var(--navy-bg);color:var(--navy)}.badge-gold{background:var(--gold-bg);color:#8B6914}.badge-green{background:var(--green-bg);color:var(--green)}.badge-red{background:var(--red-bg);color:var(--red)}.badge-amber{background:var(--amber-bg);color:var(--amber)}.badge-purple{background:var(--purple-bg);color:var(--purple)}.badge-gray{background:#F1F5F9;color:var(--muted)}

.table-wrap{overflow-x:auto;border-radius:var(--r-lg)}
table{width:100%;border-collapse:collapse}
thead tr{background:var(--cream)}
th{padding:12px 16px;text-align:left;font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.6px;text-transform:uppercase;border-bottom:2px solid var(--border);white-space:nowrap}
td{padding:14px 16px;font-size:13.5px;color:var(--text);border-bottom:1px solid var(--border);vertical-align:middle}
tbody tr{transition:background .15s}
tbody tr:hover{background:var(--cream)}
tbody tr:last-child td{border-bottom:none}
.td-name{font-weight:600;color:var(--navy)}
.td-muted{color:var(--muted);font-size:13px}
.td-actions{display:flex;gap:6px;align-items:center}
.td-btn{width:30px;height:30px;border:1px solid var(--border);border-radius:6px;background:white;display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;transition:all .15s}
.td-btn:hover{border-color:var(--navy);color:var(--navy);background:var(--navy-bg)}
.td-btn.danger:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(6,30,56,.55);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:24px}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:var(--r-xl);width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--sh-xl);animation:modalIn .2s ease}
.modal.modal-lg{max-width:800px}.modal.modal-xl{max-width:1000px}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{padding:22px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.modal-header h2{font-size:20px;color:var(--navy)}
.modal-close{width:32px;height:32px;border:1px solid var(--border);border-radius:8px;background:white;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);transition:all .15s}
.modal-close:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.modal-body{padding:28px;overflow-y:auto;flex:1}
.modal-footer{padding:18px 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-shrink:0}

.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.form-row.cols-3{grid-template-columns:1fr 1fr 1fr}
.form-field{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-label span{color:var(--red);margin-left:2px}
.input,.select-input,.textarea-input{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:13.5px;color:var(--text);background:white;transition:all .2s;outline:none}
.input:focus,.select-input:focus,.textarea-input:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(11,61,107,.08)}
.input::placeholder,.textarea-input::placeholder{color:#b0bec5}
.select-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6A7A' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.textarea-input{resize:vertical;min-height:80px}
.form-section-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--navy);margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.divider{height:1px;background:var(--border);margin:20px 0}

.tabs{display:flex;gap:4px;background:var(--cream);padding:4px;border-radius:var(--r-md);margin-bottom:24px;border:1px solid var(--border)}
.tab{padding:8px 18px;border-radius:var(--r-sm);font-size:13.5px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s;white-space:nowrap;border:none;background:none}
.tab.active{background:white;color:var(--navy);font-weight:600;box-shadow:var(--sh-sm)}

.filter-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.search-box{position:relative;flex:1;min-width:200px}
.search-box input{width:100%;padding:9px 13px 9px 36px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:13px;background:white;outline:none;transition:border-color .2s}
.search-box input:focus{border-color:var(--navy)}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted)}

.kanban-board{display:flex;gap:16px;overflow-x:auto;padding-bottom:16px;min-height:500px;align-items:flex-start}
.kanban-col{flex-shrink:0;width:260px;background:var(--cream);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden}
.kanban-col-header{padding:14px 16px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.kanban-col-title{font-size:13px;font-weight:700;color:var(--navy)}
.kanban-col-count{background:var(--navy-bg);color:var(--navy);font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}
.kanban-cards{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:60px}
.kanban-card{background:white;border-radius:var(--r-md);padding:14px;border:1px solid var(--border);box-shadow:var(--sh-sm);cursor:pointer;transition:all .15s}
.kanban-card:hover{box-shadow:var(--sh-md);transform:translateY(-2px)}
.kanban-card-name{font-size:13.5px;font-weight:600;color:var(--navy);margin-bottom:4px}
.kanban-card-service{font-size:12px;color:var(--muted);margin-bottom:8px}
.kanban-card-meta{display:flex;align-items:center;justify-content:space-between}
.kanban-card-value{font-size:13px;font-weight:600;color:var(--green)}
.kanban-card-date{font-size:11px;color:var(--muted)}
.kanban-add{margin:0 12px 12px;padding:9px;border:1.5px dashed var(--border);border-radius:var(--r-sm);background:transparent;font-size:13px;color:var(--muted);cursor:pointer;transition:all .15s;width:calc(100% - 24px);display:flex;align-items:center;justify-content:center;gap:6px}
.kanban-add:hover{border-color:var(--navy);color:var(--navy);background:white}

.timeline{list-style:none;padding:0;margin:0}
.timeline li{position:relative;padding-left:28px;padding-bottom:20px}
.timeline li:last-child{padding-bottom:0}
.timeline li::before{content:'';position:absolute;left:8px;top:20px;bottom:0;width:1px;background:var(--border)}
.timeline li:last-child::before{display:none}
.timeline-dot{position:absolute;left:0;top:4px;width:18px;height:18px;border-radius:50%;background:var(--navy-bg);border:2px solid var(--navy)}
.timeline-dot.green{background:var(--green-bg);border-color:var(--green)}
.timeline-dot.red{background:var(--red-bg);border-color:var(--red)}
.timeline-date{font-size:11px;color:var(--muted);margin-bottom:2px}
.timeline-text{font-size:13.5px;color:var(--text)}
.timeline-user{font-size:12px;color:var(--muted);margin-top:2px}

.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.chart-card{background:white;border-radius:var(--r-lg);padding:22px;border:1px solid var(--border);box-shadow:var(--sh-sm)}
.chart-title{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:16px}
.chart-container{position:relative;height:220px}
.quick-row{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}

.pagination{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-top:1px solid var(--border)}
.pagination-info{font-size:13px;color:var(--muted)}
.pagination-btns{display:flex;gap:6px}
.pg-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:6px;background:white;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;transition:all .15s;color:var(--text)}
.pg-btn:hover,.pg-btn.active{background:var(--navy);color:white;border-color:var(--navy)}

#toast-container{position:fixed;top:80px;right:28px;z-index:9999;display:flex;flex-direction:column;gap:10px}
.toast{background:white;border-radius:var(--r-md);padding:14px 18px;box-shadow:var(--sh-lg);border-left:4px solid var(--navy);display:flex;align-items:center;gap:12px;min-width:280px;max-width:380px;animation:slideIn .25s ease}
.toast.success{border-left-color:var(--green)}.toast.error{border-left-color:var(--red)}.toast.warning{border-left-color:var(--amber)}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.toast-msg{font-size:13.5px;color:var(--text);flex:1}
.toast-close{width:24px;height:24px;border:none;background:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0;display:flex;align-items:center;justify-content:center}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;text-align:center}
.empty-state-icon{width:72px;height:72px;background:var(--navy-bg);border-radius:20px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
.empty-state h3{font-size:20px;color:var(--navy);margin-bottom:8px}
.empty-state p{font-size:14px;color:var(--muted);max-width:340px;margin-bottom:20px}

.spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(11,61,107,.2);border-top-color:var(--navy);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.check-box{width:20px;height:20px;border:2px solid var(--border);border-radius:5px;flex-shrink:0;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center}
.check-box.checked{background:var(--green);border-color:var(--green);color:white}
.priority-alta{color:var(--red);font-weight:600}.priority-media{color:var(--amber);font-weight:600}.priority-baixa{color:var(--green);font-weight:600}

.contract-preview{background:white;border:1px solid var(--border);border-radius:var(--r-md);padding:40px;min-height:400px;font-size:13px;line-height:1.8}
.contract-preview .cp-header{text-align:center;margin-bottom:32px;padding-bottom:20px;border-bottom:2px solid var(--navy)}
.contract-preview .cp-logo-text{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--navy)}
.contract-preview .cp-subtitle{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.contract-preview .cp-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;text-align:center;margin:24px 0 16px;color:var(--navy)}
.contract-preview p{margin-bottom:14px;text-align:justify}
.contract-preview .cp-clause{font-weight:700;color:var(--navy);display:block;margin-top:20px;margin-bottom:8px}
.contract-preview .cp-sign{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:48px;border-top:1px solid var(--border);padding-top:24px}
.sign-block{text-align:center}.sign-line{height:1px;background:var(--border);margin-bottom:8px}
.sign-name{font-size:13px;font-weight:600}.sign-role{font-size:12px;color:var(--muted)}

.report-builder{display:grid;grid-template-columns:280px 1fr;gap:20px}
.report-panel{background:white;border-radius:var(--r-lg);border:1px solid var(--border);padding:20px}
.report-panel h3{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.filter-chip{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:var(--navy-bg);color:var(--navy);border-radius:20px;font-size:12px;font-weight:600;margin:3px;cursor:pointer;border:1.5px solid transparent;transition:all .15s}
.filter-chip.selected{background:var(--navy);color:white;border-color:var(--navy)}

.notif-panel{position:absolute;top:calc(var(--topbar-h) + 8px);right:28px;width:340px;background:white;border-radius:var(--r-xl);box-shadow:var(--sh-xl);border:1px solid var(--border);z-index:500;overflow:hidden;animation:modalIn .2s ease}
.notif-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.notif-header h4{font-size:14px;font-weight:700;color:var(--navy)}
.notif-item{padding:14px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.notif-item:hover{background:var(--cream)}
.notif-item:last-child{border-bottom:none}
.notif-item-title{font-size:13.5px;font-weight:600;color:var(--text);margin-bottom:2px}
.notif-item-desc{font-size:12px;color:var(--muted)}
.notif-item-time{font-size:11px;color:var(--muted);margin-top:4px}

@media(max-width:1024px){.charts-grid{grid-template-columns:1fr}.quick-row{grid-template-columns:1fr}.form-row.cols-3{grid-template-columns:1fr 1fr}#sidebar{width:64px}.sidebar-logo-txt,.nav-item-label,.nav-section-label,.user-info,.nav-badge,.sidebar-collapse-btn{display:none}}
@media(max-width:768px){.global-search{display:none}#content{padding:16px}.form-row{grid-template-columns:1fr}.kanban-board{flex-direction:column}.kanban-col{width:100%}.login-left{display:none}.login-right{width:100%;border-left:none;padding:32px 24px}}
</style>
</head>
<body>
<div id="toast-container"></div>
<!-- LOGIN PAGE -->
<div id="login-page" class="active">
  <div class="login-orb"></div>
  <div class="login-left">
    <div class="login-logo">
      <div class="login-logo-mark"><img src="icone.png" style="width:44px;height:44px;object-fit:contain;border-radius:8px;" alt="BIMAT"/></div>
      <div class="login-logo-txt"><div class="name">BIMAT</div><div class="sub">Solu√ß√µes Jur√≠dicas</div></div>
    </div>
    <h1 class="login-headline">Gest√£o inteligente<br>de benef√≠cios <span>INSS</span></h1>
    <p class="login-mission">Centralize processos, contratos e financeiro em uma √∫nica plataforma. Mais efici√™ncia, menos burocracia para sua equipe especializada.</p>
    <div class="login-stats">
      <div class="login-stat"><div class="num">+500</div><div class="lbl">Clientes Ativos</div></div>
      <div class="login-divider"></div>
      <div class="login-stat"><div class="num">98%</div><div class="lbl">Taxa Deferimento</div></div>
      <div class="login-divider"></div>
      <div class="login-stat"><div class="num">8</div><div class="lbl">M√≥dulos CRM</div></div>
    </div>
  </div>
  <div class="login-right">
    <div class="login-card">
      <div class="login-card-header"><h2>Bem-vindo de volta</h2><p>Entre com suas credenciais de acesso</p></div>
      <div class="login-error" id="login-error"></div>
      <div class="form-group"><label>E-mail</label><input class="form-input" type="email" id="login-email" placeholder="seu@bimat.com.br" autocomplete="email"/></div>
      <div class="form-group"><label>Senha</label><input class="form-input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <button class="btn-primary" id="login-btn" onclick="doLogin()"><span id="login-btn-text">Entrar no CRM</span></button>
      <span class="login-forgot" onclick="doForgotPassword()">Esqueci minha senha</span>
      <p style="font-size:11px;color:var(--muted);text-align:center;margin-top:16px">Demo: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2a4b4e4743446a4843474b5e04494547044858">[email&#160;protected]</a> / bimat2024</p>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <nav id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-mark"><img src="icone.png" style="width:26px;height:26px;object-fit:contain;border-radius:6px;" alt="B"/></div>
      <div class="sidebar-logo-txt"><div class="sidebar-logo-name">BIMAT</div><div class="sidebar-logo-sub">CRM</div></div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Principal</div>
      <div class="nav-item active" onclick="navigate('dashboard')" data-section="dashboard">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        <span class="nav-item-label">Dashboard</span>
      </div>
      <div class="nav-section-label" style="margin-top:8px">Comercial</div>
      <div class="nav-item" onclick="navigate('clients')" data-section="clients">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        <span class="nav-item-label">Clientes</span>
      </div>
      <div class="nav-item" onclick="navigate('funnel')" data-section="funnel">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        <span class="nav-item-label">Funil Comercial</span>
      </div>
      <div class="nav-item" onclick="navigate('proposals')" data-section="proposals">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span class="nav-item-label">Propostas</span>
      </div>
      <div class="nav-section-label" style="margin-top:8px">Operacional</div>
      <div class="nav-item" onclick="navigate('contracts')" data-section="contracts">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span class="nav-item-label">Contratos</span>
      </div>
      <div class="nav-item" onclick="navigate('processes')" data-section="processes">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <span class="nav-item-label">Processos INSS</span>
        <span class="nav-badge" id="badge-processes" style="display:none">0</span>
      </div>
      <div class="nav-item" onclick="navigate('tasks')" data-section="tasks">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        <span class="nav-item-label">Tarefas</span>
        <span class="nav-badge" id="badge-tasks" style="display:none">0</span>
      </div>
      <div class="nav-section-label" style="margin-top:8px">Financeiro</div>
      <div class="nav-item" onclick="navigate('financial')" data-section="financial">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
        <span class="nav-item-label">Financeiro</span>
      </div>
      <div class="nav-section-label" style="margin-top:8px">An√°lise &amp; Admin</div>
      <div class="nav-item" onclick="navigate('reports')" data-section="reports">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span class="nav-item-label">Relat√≥rios</span>
      </div>
      <div class="nav-item" id="nav-users" onclick="navigate('users')" data-section="users">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span class="nav-item-label">Usu√°rios</span>
      </div>
      <div class="nav-item" onclick="navigate('settings')" data-section="settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span class="nav-item-label">Configura√ß√µes</span>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="user-avatar" id="sidebar-avatar">A</div>
      <div class="user-info">
        <div class="user-name" id="sidebar-name">Admin BIMAT</div>
        <div class="user-role" id="sidebar-role">Admin</div>
      </div>
      <button class="sidebar-collapse-btn" onclick="toggleSidebar()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
    </div>
  </nav>

  <div id="main-area">
    <header id="topbar">
      <div>
        <div class="topbar-breadcrumb" id="topbar-breadcrumb">BIMAT CRM</div>
        <div class="topbar-title" id="topbar-title">Dashboard</div>
      </div>
      <div class="global-search">
        <svg class="global-search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Buscar cliente, proposta, processo..." id="global-search-input" oninput="globalSearch(this.value)"/>
      </div>
      <div class="topbar-actions" style="position:relative">
        <button class="topbar-btn" onclick="toggleNotifications()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
          <div class="notif-dot" id="notif-dot"></div>
        </button>
        <div class="notif-panel" id="notif-panel" style="display:none">
          <div class="notif-header"><h4>Notifica√ß√µes</h4><span style="font-size:12px;color:var(--navy);cursor:pointer">Fechar</span></div>
          <div id="notif-list"></div>
        </div>
        <button class="topbar-btn" onclick="doLogout()" title="Sair">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </header>

    <div id="content">
      <!-- DASHBOARD -->
      <div class="content-section active" id="section-dashboard">
        <div class="page-header">
          <div class="page-header-left"><h1>Dashboard Executivo</h1><p>Vis√£o geral do neg√≥cio em tempo real</p></div>
          <div style="display:flex;gap:10px">
            <select class="input" style="width:160px" id="dash-period" onchange="loadDashboard()"><option value="month">Este m√™s</option><option value="year">Este ano</option></select>
            <button class="btn btn-outline btn-sm" onclick="loadDashboard()">‚Üª Atualizar</button>
          </div>
        </div>
        <div class="stats-grid" id="dash-stats"></div>
        <div class="charts-grid">
          <div class="chart-card"><div class="chart-title">Leads por Etapa do Funil</div><div class="chart-container"><canvas id="chart-funnel"></canvas></div></div>
          <div class="chart-card"><div class="chart-title">Recebimentos Mensais (R$)</div><div class="chart-container"><canvas id="chart-financial"></canvas></div></div>
          <div class="chart-card"><div class="chart-title">Processos INSS por Status</div><div class="chart-container"><canvas id="chart-processes"></canvas></div></div>
          <div class="chart-card"><div class="chart-title">Origem dos Leads</div><div class="chart-container"><canvas id="chart-leads"></canvas></div></div>
        </div>
        <div class="quick-row">
          <div class="card"><div class="card-header"><h3>‚ö†Ô∏è Alertas &amp; Pend√™ncias</h3><span style="font-size:12px;color:var(--muted)">Pr√≥ximos 7 dias</span></div><div class="card-body" id="dash-alerts"></div></div>
          <div class="card"><div class="card-header"><h3>üìã Tarefas de Hoje</h3></div><div class="card-body" id="dash-tasks-today"></div></div>
        </div>
      </div>

      <!-- CLIENTS -->
      <div class="content-section" id="section-clients">
        <div class="page-header">
          <div class="page-header-left"><h1>Clientes</h1><p>Cadastro e gest√£o de clientes PF/PJ</p></div>
          <button class="btn btn-navy" onclick="openClientModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Novo Cliente</button>
        </div>
        <div class="filter-bar">
          <div class="search-box"><svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Buscar por nome, CPF, e-mail..." oninput="filterClients(this.value)"/></div>
          <select class="input" style="width:160px" id="client-origin-filter" onchange="filterClients()"><option value="">Todas origens</option><option>Google</option><option>Instagram</option><option>WhatsApp</option><option>Indica√ß√£o</option><option>Outro</option></select>
          <button class="btn btn-outline btn-sm" onclick="exportClientsCSV()">‚Üì CSV</button>
        </div>
        <div class="card"><div class="table-wrap"><table id="clients-table"><thead><tr><th>Nome / CPF</th><th>Contato</th><th>Cidade/UF</th><th>Origem</th><th>Desde</th><th>A√ß√µes</th></tr></thead><tbody id="clients-tbody"></tbody></table></div><div class="pagination" id="clients-pagination"></div></div>
      </div>

      <!-- FUNNEL -->
      <div class="content-section" id="section-funnel">
        <div class="page-header">
          <div class="page-header-left"><h1>Funil Comercial</h1><p>Pipeline Kanban de leads e oportunidades</p></div>
          <button class="btn btn-navy" onclick="openProposalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Novo Lead</button>
        </div>
        <div class="kanban-board" id="kanban-board"></div>
      </div>

      <!-- PROPOSALS -->
      <div class="content-section" id="section-proposals">
        <div class="page-header">
          <div class="page-header-left"><h1>Propostas</h1><p>Gest√£o e acompanhamento de propostas comerciais</p></div>
          <button class="btn btn-navy" onclick="openProposalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova Proposta</button>
        </div>
        <div class="filter-bar">
          <div class="search-box"><svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Buscar proposta..." oninput="filterProposals(this.value)"/></div>
          <select class="input" style="width:160px" onchange="filterProposalsByStatus(this.value)"><option value="">Todos status</option><option value="rascunho">Rascunho</option><option value="enviada">Enviada</option><option value="aprovada">Aprovada</option><option value="cancelada">Cancelada</option></select>
        </div>
        <div class="card"><div class="table-wrap"><table><thead><tr><th>#</th><th>Cliente</th><th>Servi√ßo</th><th>Valor</th><th>Pagamento</th><th>Status</th><th>Data</th><th>A√ß√µes</th></tr></thead><tbody id="proposals-tbody"></tbody></table></div><div class="pagination" id="proposals-pagination"></div></div>
      </div>

      <!-- CONTRACTS -->
      <div class="content-section" id="section-contracts">
        <div class="page-header"><div class="page-header-left"><h1>Contratos &amp; Documentos</h1><p>Gera√ß√£o, versionamento e armazenamento</p></div></div>
        <div class="tabs">
          <button class="tab active" onclick="switchContractTab('list',this)">Contratos</button>
          <button class="tab" onclick="switchContractTab('templates',this)">Templates</button>
          <button class="tab" onclick="switchContractTab('docs',this)">Documentos</button>
        </div>
        <div id="contracts-tab-list">
          <div class="card"><div class="table-wrap"><table><thead><tr><th>#</th><th>Cliente</th><th>Servi√ßo</th><th>Vers√£o</th><th>Status</th><th>Criado em</th><th>A√ß√µes</th></tr></thead><tbody id="contracts-tbody"></tbody></table></div></div>
        </div>
        <div id="contracts-tab-templates" style="display:none">
          <div style="display:flex;justify-content:flex-end;margin-bottom:16px"><button class="btn btn-navy" onclick="openTemplateModal()">+ Novo Template</button></div>
          <div id="templates-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px"></div>
        </div>
        <div id="contracts-tab-docs" style="display:none">
          <div class="card"><div class="card-body"><div class="empty-state"><div class="empty-state-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><h3>Documentos Anexados</h3><p>Documentos de clientes (RG, CPF, CNIS, procura√ß√µes) aparecem aqui ap√≥s upload</p></div></div></div>
        </div>
      </div>

      <!-- PROCESSES -->
      <div class="content-section" id="section-processes">
        <div class="page-header">
          <div class="page-header-left"><h1>Processos INSS</h1><p>Acompanhamento de requerimentos e benef√≠cios</p></div>
          <button class="btn btn-navy" onclick="openProcessModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Novo Processo</button>
        </div>
        <div class="filter-bar">
          <div class="search-box"><svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Buscar por cliente, protocolo..." oninput="filterProcesses(this.value)"/></div>
          <select class="input" style="width:180px" onchange="filterProcessesByStatus(this.value)"><option value="">Todos status</option><option>Em an√°lise</option><option>Exig√™ncia</option><option>Per√≠cia</option><option>Deferido</option><option>Indeferido</option><option>Recurso</option><option>Encerrado</option></select>
          <select class="input" style="width:200px" onchange="filterProcessesByType(this.value)"><option value="">Todos os tipos</option><option>Aposentadoria por Idade</option><option>Aposentadoria por Tempo de Contribui√ß√£o</option><option>BPC/LOAS</option><option>Aux√≠lio-Doen√ßa</option><option>Pens√£o por Morte</option><option>Sal√°rio-Maternidade</option><option>Revis√£o de Benef√≠cio</option><option>Recurso Administrativo</option></select>
        </div>
        <div class="card"><div class="table-wrap"><table><thead><tr><th>Cliente</th><th>Tipo</th><th>Protocolo</th><th>Status</th><th>Requerimento</th><th>Prazo</th><th>Respons√°vel</th><th>A√ß√µes</th></tr></thead><tbody id="processes-tbody"></tbody></table></div><div class="pagination" id="processes-pagination"></div></div>
      </div>

      <!-- TASKS -->
      <div class="content-section" id="section-tasks">
        <div class="page-header">
          <div class="page-header-left"><h1>Tarefas</h1><p>Gerenciamento de atividades e prazos</p></div>
          <button class="btn btn-navy" onclick="openTaskModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova Tarefa</button>
        </div>
        <div class="tabs">
          <button class="tab active" onclick="filterTasksByStatus('todas',this)">Todas</button>
          <button class="tab" onclick="filterTasksByStatus('pendente',this)">Pendentes</button>
          <button class="tab" onclick="filterTasksByStatus('vencida',this)">Vencidas</button>
          <button class="tab" onclick="filterTasksByStatus('concluida',this)">Conclu√≠das</button>
        </div>
        <div class="card"><div class="table-wrap"><table><thead><tr><th>Tarefa</th><th>Cliente/Processo</th><th>Respons√°vel</th><th>Prioridade</th><th>Vencimento</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="tasks-tbody"></tbody></table></div></div>
      </div>

      <!-- FINANCIAL -->
      <div class="content-section" id="section-financial">
        <div class="page-header"><div class="page-header-left"><h1>Financeiro</h1><p>Contas a receber, baixas e renegocia√ß√µes</p></div></div>
        <div class="stats-grid" id="fin-stats"></div>
        <div class="tabs">
          <button class="tab active" onclick="switchFinTab('receivable',this)">Contas a Receber</button>
          <button class="tab" onclick="switchFinTab('renegotiation',this)">Renegocia√ß√µes</button>
        </div>
        <div id="fin-tab-receivable">
          <div class="filter-bar">
            <div class="search-box"><svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Buscar por cliente..." oninput="filterParcelas(this.value)"/></div>
            <select class="input" style="width:140px" onchange="filterParcelasByStatus(this.value)"><option value="">Todos</option><option>Aberta</option><option>Paga</option><option>Atrasada</option><option>Cancelada</option></select>
            <input class="input" type="month" style="width:160px" id="fin-month-filter" onchange="filterParcelasByMonth(this.value)"/>
            <button class="btn btn-outline btn-sm" onclick="exportFinancialCSV()">‚Üì CSV</button>
          </div>
          <div class="card"><div class="table-wrap"><table><thead><tr><th>Cliente</th><th>Servi√ßo</th><th>Parcela</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>Pagamento</th><th>A√ß√µes</th></tr></thead><tbody id="parcelas-tbody"></tbody></table></div><div class="pagination" id="parcelas-pagination"></div></div>
        </div>
        <div id="fin-tab-renegotiation" style="display:none">
          <div class="card"><div class="card-body"><div class="empty-state"><div class="empty-state-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg></div><h3>Renegocia√ß√µes</h3><p>Selecione parcelas em aberto na aba anterior e clique em renegociar para criar novos planos de pagamento</p></div></div></div>
        </div>
      </div>

      <!-- REPORTS -->
      <div class="content-section" id="section-reports">
        <div class="page-header">
          <div class="page-header-left"><h1>Gerador de Relat√≥rios</h1><p>Relat√≥rios avan√ßados com filtros, agrupamentos e exporta√ß√£o</p></div>
          <button class="btn btn-gold" onclick="saveReportModel()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg> Salvar Modelo</button>
        </div>
        <div class="report-builder">
          <div>
            <div class="report-panel" style="margin-bottom:16px">
              <h3>üóÇÔ∏è Fonte de Dados</h3>
              <div style="display:flex;flex-direction:column;gap:10px">
                <label style="display:flex;align-items:center;gap:8px;font-size:13.5px;cursor:pointer"><input type="radio" name="report-source" value="proposals" checked onchange="updateReportColumns()"> Propostas</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13.5px;cursor:pointer"><input type="radio" name="report-source" value="parcelas" onchange="updateReportColumns()"> Financeiro (Parcelas)</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13.5px;cursor:pointer"><input type="radio" name="report-source" value="processes" onchange="updateReportColumns()"> Processos INSS</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13.5px;cursor:pointer"><input type="radio" name="report-source" value="clients" onchange="updateReportColumns()"> Clientes</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13.5px;cursor:pointer"><input type="radio" name="report-source" value="tasks" onchange="updateReportColumns()"> Tarefas</label>
              </div>
            </div>
            <div class="report-panel" style="margin-bottom:16px">
              <h3>üìÖ Per√≠odo</h3>
              <div class="form-field"><label class="form-label">De</label><input type="date" class="input" id="report-date-from"/></div>
              <div class="form-field" style="margin-bottom:0"><label class="form-label">At√©</label><input type="date" class="input" id="report-date-to"/></div>
            </div>
            <div class="report-panel" style="margin-bottom:16px">
              <h3>üîç Filtros Adicionais</h3>
              <div class="form-field"><label class="form-label">Status</label><select class="select-input" id="report-filter-status"><option value="">Todos</option></select></div>
              <div class="form-field" style="margin-bottom:0"><label class="form-label">Agrupamento</label><select class="select-input" id="report-group-by"><option value="">Sem agrupamento</option><option value="month">Por m√™s</option><option value="status">Por status</option><option value="service">Por servi√ßo</option></select></div>
            </div>
            <button class="btn btn-navy" style="width:100%" onclick="runReport()">‚ñ∂ Gerar Relat√≥rio</button>
          </div>
          <div>
            <div class="report-panel" style="margin-bottom:16px"><h3>üìä Colunas do Relat√≥rio</h3><div id="report-columns" style="display:flex;flex-wrap:wrap;gap:6px"></div></div>
            <div class="card" id="report-results" style="display:none">
              <div class="card-header"><h3 id="report-results-title">Resultados</h3><div style="display:flex;gap:8px"><button class="btn btn-outline btn-sm" onclick="exportReportCSV()">CSV</button><button class="btn btn-navy btn-sm" onclick="exportReportPDF()">PDF</button></div></div>
              <div class="table-wrap"><table><thead id="report-table-head"></thead><tbody id="report-table-body"></tbody></table></div>
              <div id="report-summary" style="padding:16px 20px;border-top:1px solid var(--border);background:var(--cream)"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div class="content-section" id="section-users">
        <div class="page-header">
          <div class="page-header-left"><h1>Usu√°rios &amp; Permiss√µes</h1><p>Gest√£o de acesso e perfis RBAC</p></div>
          <div style="display:flex;gap:10px">
            <button class="btn btn-outline btn-sm" onclick="resetPermissions()">‚Ü∫ Resetar Permiss√µes</button>
            <button class="btn btn-navy" onclick="openUserModal()">+ Novo Usu√°rio</button>
          </div>
        </div>
        <div class="card" style="margin-bottom:24px"><div class="table-wrap"><table><thead><tr><th>Usu√°rio</th><th>E-mail</th><th>Perfil</th><th>√öltimo acesso</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="users-tbody"></tbody></table></div></div>
        <div class="card">
          <div class="card-header">
            <h3>Matriz de Permiss√µes por Perfil</h3>
          </div>
          <div class="card-body">
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Marque as caixas para personalizar as permiss√µes de cada perfil. <strong>V</strong>=Visualizar, <strong>C</strong>=Criar/Editar, <strong>D</strong>=Excluir. Altera√ß√µes s√£o salvas automaticamente. Admin sempre tem acesso total.</p>
            <div class="table-wrap"><table><thead><tr><th>M√≥dulo</th><th style="text-align:center">Admin</th><th style="text-align:center">Gestor</th><th style="text-align:center">Operacional</th><th style="text-align:center">Comercial</th><th style="text-align:center">Financeiro</th><th style="text-align:center">Leitura</th></tr></thead><tbody id="perms-tbody"></tbody></table></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="content-section" id="section-settings">
        <div class="page-header"><div class="page-header-left"><h1>Configura√ß√µes</h1><p>Configura√ß√µes Firebase e perfil do usu√°rio</p></div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card">
            <div class="card-header"><h3>üîß Configura√ß√£o Firebase</h3></div>
            <div class="card-body">
              <div id="fb-status" style="padding:10px 14px;border-radius:8px;background:var(--cream);margin-bottom:16px;font-size:13px;border:1px solid var(--border)">Verificando conex√£o...</div>
              <p style="font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.6">Cole as configura√ß√µes do seu projeto Firebase para ativar autentica√ß√£o real e banco de dados em nuvem. Ap√≥s salvar, recarregue a p√°gina.</p>
              <div class="form-field"><label class="form-label">API Key</label><input class="input" type="text" id="fb-api-key" placeholder="AIzaSy..."/></div>
              <div class="form-field"><label class="form-label">Auth Domain</label><input class="input" type="text" id="fb-auth-domain" placeholder="projeto.firebaseapp.com"/></div>
              <div class="form-field"><label class="form-label">Project ID</label><input class="input" type="text" id="fb-project-id" placeholder="meu-projeto"/></div>
              <div class="form-field"><label class="form-label">Storage Bucket</label><input class="input" type="text" id="fb-storage-bucket" placeholder="projeto.appspot.com"/></div>
              <div class="form-field"><label class="form-label">App ID</label><input class="input" type="text" id="fb-app-id" placeholder="1:xxx:web:xxx"/></div>
              <button class="btn btn-navy" onclick="saveFirebaseConfig()">Salvar e Reconectar</button>
              <div class="divider"></div>
              <h4 style="font-size:15px;color:var(--navy);margin-bottom:12px">Regras Firestore (RBAC)</h4>
              <pre style="font-size:11px;background:var(--navy-deep);color:#e2e8f0;padding:14px;border-radius:8px;overflow:auto;line-height:1.5">rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function isAuth() { return request.auth != null; }
    function role() { return get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role; }
    function isAdmin() { return role() == 'admin'; }
    function isGestor() { return role() in ['admin','gestor']; }
    
    match /clients/{id} { allow read: if isAuth(); allow write: if isGestor(); }
    match /proposals/{id} { allow read: if isAuth(); allow write: if isGestor(); }
    match /contracts/{id} { allow read: if isAuth(); allow write: if isGestor(); }
    match /processes/{id} { allow read: if isAuth(); allow write: if isAuth(); }
    match /parcelas/{id} { allow read: if isAuth(); allow write: if role() in ['admin','gestor','financeiro']; }
    match /tasks/{id} { allow read: if isAuth(); allow write: if isAuth(); }
    match /users/{id} { allow read: if isAuth(); allow write: if isAdmin(); }
    match /audit_logs/{id} { allow read: if isGestor(); allow create: if isAuth(); }
    match /config/{id} { allow read: if isAuth(); allow write: if isAdmin(); }
  }
}</pre>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>üë§ Meu Perfil</h3></div>
            <div class="card-body">
              <div class="form-field"><label class="form-label">Nome completo</label><input class="input" type="text" id="profile-name" placeholder="Seu nome"/></div>
              <div class="form-field"><label class="form-label">E-mail</label><input class="input" type="email" id="profile-email" disabled/></div>
              <div class="form-field"><label class="form-label">Nova senha</label><input class="input" type="password" id="profile-new-pass" placeholder="Deixe em branco para manter"/></div>
              <button class="btn btn-navy" onclick="updateProfile()">Salvar Altera√ß√µes</button>
              <div class="divider"></div>
              <h4 style="font-size:15px;color:var(--navy);margin-bottom:12px">Modelagem Firestore</h4>
              <p style="font-size:12px;color:var(--muted);line-height:1.8"><strong>Cole√ß√µes:</strong> /users, /clients, /proposals, /contracts, /processes, /parcelas, /tasks, /documents, /audit_logs, /templates<br><br><strong>Storage PDF:</strong> /contracts/{id}/v{n}.pdf<br>/documents/{clientId}/{tipo}_{timestamp}<br><br><strong>Auditoria:</strong> toda a√ß√£o cr√≠tica registra usu√°rio, data/hora e descri√ß√£o em /audit_logs com TTL de 1 ano.</p>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main-area -->
</div><!-- /app -->
<!-- MODALS -->
<!-- Client Modal -->
<div class="modal-overlay" id="client-modal">
  <div class="modal modal-lg">
    <div class="modal-header"><h2 id="client-modal-title">Novo Cliente</h2><button class="modal-close" onclick="closeModal('client-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="client-id"/>
      <h4 class="form-section-title">Dados Pessoais</h4>
      <div class="form-row"><div class="form-field"><label class="form-label">Nome Completo <span>*</span></label><input class="input" type="text" id="c-name" placeholder="Nome completo"/></div><div class="form-field"><label class="form-label">CPF <span>*</span></label><input class="input" type="text" id="c-cpf" placeholder="000.000.000-00" oninput="maskCPF(this)"/></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">RG</label><input class="input" type="text" id="c-rg" placeholder="RG"/></div><div class="form-field"><label class="form-label">Data de Nascimento</label><input class="input" type="date" id="c-birth"/></div></div>
      <h4 class="form-section-title">Contato</h4>
      <div class="form-row"><div class="form-field"><label class="form-label">WhatsApp <span>*</span></label><input class="input" type="tel" id="c-phone" placeholder="(11) 99999-9999"/></div><div class="form-field"><label class="form-label">E-mail</label><input class="input" type="email" id="c-email" placeholder="email@cliente.com"/></div></div>
      <h4 class="form-section-title">Endere√ßo</h4>
      <div class="form-row"><div class="form-field"><label class="form-label">CEP</label><input class="input" type="text" id="c-cep" placeholder="00000-000" oninput="maskCEP(this)" onblur="fetchCEP()"/></div><div class="form-field"><label class="form-label">Logradouro</label><input class="input" type="text" id="c-street" placeholder="Rua, Av."/></div></div>
      <div class="form-row cols-3"><div class="form-field"><label class="form-label">N¬∫</label><input class="input" type="text" id="c-number"/></div><div class="form-field"><label class="form-label">Bairro</label><input class="input" type="text" id="c-neighborhood"/></div><div class="form-field"><label class="form-label">Complemento</label><input class="input" type="text" id="c-complement"/></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Cidade</label><input class="input" type="text" id="c-city"/></div><div class="form-field"><label class="form-label">UF</label><select class="select-input" id="c-state"><option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option><option>RO</option><option>RR</option><option>SC</option><option selected>SP</option><option>SE</option><option>TO</option></select></div></div>
      <h4 class="form-section-title">Origem &amp; Obs.</h4>
      <div class="form-row"><div class="form-field"><label class="form-label">Origem do Lead</label><select class="select-input" id="c-origin"><option>WhatsApp</option><option>Google</option><option>Instagram</option><option>Indica√ß√£o</option><option>Outro</option></select></div><div class="form-field"><label class="form-label">NB / N√∫mero Benef√≠cio INSS</label><input class="input" type="text" id="c-nb" placeholder="NB (se houver)"/></div></div>
      <div class="form-field"><label class="form-label">Observa√ß√µes</label><textarea class="textarea-input" id="c-obs" rows="3" placeholder="Anota√ß√µes sobre o cliente..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('client-modal')">Cancelar</button><button class="btn btn-navy" onclick="saveClient()">Salvar Cliente</button></div>
  </div>
</div>

<!-- Proposal Modal -->
<div class="modal-overlay" id="proposal-modal">
  <div class="modal modal-lg">
    <div class="modal-header"><h2 id="proposal-modal-title">Nova Proposta</h2><button class="modal-close" onclick="closeModal('proposal-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="prop-id"/>
      <div class="form-row"><div class="form-field"><label class="form-label">Cliente <span>*</span></label><select class="select-input" id="prop-client"></select></div><div class="form-field"><label class="form-label">Tipo de Servi√ßo <span>*</span></label><select class="select-input" id="prop-service"><option value="">Selecione...</option><option>Assessoria/Requerimento INSS</option><option>Aposentadoria por Idade</option><option>Aposentadoria por Tempo de Contribui√ß√£o</option><option>Aposentadoria por Invalidez</option><option>BPC/LOAS</option><option>Aux√≠lio-Doen√ßa</option><option>Pens√£o por Morte</option><option>Sal√°rio-Maternidade</option><option>Revis√£o de Benef√≠cio</option><option>Recurso Administrativo</option><option>Confec√ß√£o de Documentos</option><option>Procura√ß√£o</option><option>Outro</option></select></div></div>
      <div class="form-field"><label class="form-label">Escopo / Descri√ß√£o detalhada</label><textarea class="textarea-input" id="prop-scope" rows="2" placeholder="Descreva o escopo do servi√ßo..."></textarea></div>
      <div class="form-row cols-3"><div class="form-field"><label class="form-label">Valor Total (R$) <span>*</span></label><input class="input" type="number" id="prop-value" placeholder="0,00" step="0.01" oninput="calcParcelas()"/></div><div class="form-field"><label class="form-label">Forma de Pagamento</label><select class="select-input" id="prop-payment" onchange="calcParcelas()"><option value="avista">√Ä vista</option><option value="parcelado">Parcelado</option><option value="entrada">Entrada + Parcelas</option></select></div><div class="form-field" id="prop-parcelas-field"><label class="form-label">N¬∫ Parcelas</label><input class="input" type="number" id="prop-n-parcelas" value="1" min="1" max="24" oninput="calcParcelas()"/></div></div>
      <div class="form-field" id="prop-entrada-field" style="display:none"><label class="form-label">Valor da Entrada (R$)</label><input class="input" type="number" id="prop-entrada" placeholder="0,00" oninput="calcParcelas()"/></div>
      <div id="prop-parcelas-preview" style="background:var(--cream);border-radius:var(--r-md);padding:14px;margin-bottom:16px;display:none"><div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px">Resumo do Pagamento</div><div id="prop-parcelas-list" style="font-size:13px"></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Data da Proposta</label><input class="input" type="date" id="prop-date"/></div><div class="form-field"><label class="form-label">Validade</label><input class="input" type="date" id="prop-expiry"/></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Status</label><select class="select-input" id="prop-status"><option value="rascunho">Rascunho</option><option value="enviada">Enviada</option><option value="aprovada">Aprovada</option><option value="cancelada">Cancelada</option></select></div><div class="form-field"><label class="form-label">Etapa do Funil</label><select class="select-input" id="prop-stage"><option>Lead novo</option><option>Em atendimento</option><option>Aguardando documentos</option><option>An√°lise t√©cnica</option><option>Proposta enviada</option><option>Proposta aprovada</option><option>Contrato assinado</option><option>Processo protocolado</option><option>Indeferido</option><option>Deferido</option><option>Encerrado</option></select></div></div>
      <div class="form-field"><label class="form-label">Observa√ß√µes internas</label><textarea class="textarea-input" id="prop-obs" rows="2" placeholder="Notas internas..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('proposal-modal')">Cancelar</button>
      <button class="btn btn-success" id="btn-approve-proposal" style="display:none" onclick="approveProposal()">‚úì Aprovar e Gerar Contrato</button>
      <button class="btn btn-navy" onclick="saveProposal()">Salvar Proposta</button>
    </div>
  </div>
</div>

<!-- Process Modal -->
<div class="modal-overlay" id="process-modal">
  <div class="modal modal-lg">
    <div class="modal-header"><h2 id="process-modal-title">Novo Processo INSS</h2><button class="modal-close" onclick="closeModal('process-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="proc-id"/>
      <div class="form-row"><div class="form-field"><label class="form-label">Cliente <span>*</span></label><select class="select-input" id="proc-client"></select></div><div class="form-field"><label class="form-label">Tipo de Benef√≠cio <span>*</span></label><select class="select-input" id="proc-type"><option>Aposentadoria por Idade</option><option>Aposentadoria por Tempo de Contribui√ß√£o</option><option>Aposentadoria por Invalidez</option><option>BPC/LOAS</option><option>Aux√≠lio-Doen√ßa</option><option>Aux√≠lio-Acidente</option><option>Pens√£o por Morte</option><option>Sal√°rio-Maternidade</option><option>Revis√£o de Benef√≠cio</option><option>Recurso Administrativo</option></select></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">N¬∫ de Protocolo</label><input class="input" type="text" id="proc-protocol" placeholder="NUP / Protocolo INSS"/></div><div class="form-field"><label class="form-label">Data de Requerimento</label><input class="input" type="date" id="proc-req-date"/></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Status no INSS</label><select class="select-input" id="proc-status"><option>Em an√°lise</option><option>Exig√™ncia</option><option>Per√≠cia</option><option>Deferido</option><option>Indeferido</option><option>Recurso</option><option>Encerrado</option></select></div><div class="form-field"><label class="form-label">Prazo / Data Limite</label><input class="input" type="date" id="proc-deadline"/></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Respons√°vel</label><select class="select-input" id="proc-responsible"></select></div><div class="form-field"><label class="form-label">Proposta Vinculada</label><select class="select-input" id="proc-proposal"></select></div></div>
      <div class="form-field"><label class="form-label">Observa√ß√µes / Anota√ß√µes</label><textarea class="textarea-input" id="proc-obs" rows="3" placeholder="Hist√≥rico e anota√ß√µes do processo..."></textarea></div>
      <h4 class="form-section-title">Checklist de Documentos</h4>
      <ul class="checklist" id="proc-checklist-list" style="list-style:none;padding:0;margin-bottom:12px"></ul>
      <div style="display:flex;gap:8px"><input class="input" type="text" id="proc-new-check" placeholder="Adicionar item ao checklist..." style="flex:1"/><button class="btn btn-outline btn-sm" onclick="addChecklistItem()">+ Adicionar</button></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('process-modal')">Cancelar</button><button class="btn btn-navy" onclick="saveProcess()">Salvar Processo</button></div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <div class="modal-header"><h2 id="task-modal-title">Nova Tarefa</h2><button class="modal-close" onclick="closeModal('task-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="task-id"/>
      <div class="form-field"><label class="form-label">T√≠tulo <span>*</span></label><input class="input" type="text" id="task-title" placeholder="Descreva a tarefa..."/></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Respons√°vel</label><select class="select-input" id="task-responsible"></select></div><div class="form-field"><label class="form-label">Prioridade</label><select class="select-input" id="task-priority"><option value="alta">Alta</option><option value="media" selected>M√©dia</option><option value="baixa">Baixa</option></select></div></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Vencimento</label><input class="input" type="date" id="task-due"/></div><div class="form-field"><label class="form-label">Cliente / Refer√™ncia</label><input class="input" type="text" id="task-client-name" placeholder="Nome do cliente..."/></div></div>
      <div class="form-field"><label class="form-label">Descri√ß√£o</label><textarea class="textarea-input" id="task-desc" rows="3" placeholder="Detalhes da tarefa..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('task-modal')">Cancelar</button><button class="btn btn-navy" onclick="saveTask()">Salvar Tarefa</button></div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="payment-modal">
  <div class="modal">
    <div class="modal-header"><h2>Registrar Pagamento</h2><button class="modal-close" onclick="closeModal('payment-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="pay-parcela-id"/>
      <div id="pay-info" style="background:var(--cream);border-radius:var(--r-md);padding:14px;margin-bottom:16px;font-size:13.5px"></div>
      <div class="form-row"><div class="form-field"><label class="form-label">Data do Pagamento <span>*</span></label><input class="input" type="date" id="pay-date"/></div><div class="form-field"><label class="form-label">Forma de Pagamento</label><select class="select-input" id="pay-method"><option>Pix</option><option>Cart√£o de Cr√©dito</option><option>Cart√£o de D√©bito</option><option>Transfer√™ncia</option><option>Dinheiro</option><option>Boleto</option></select></div></div>
      <div class="form-field"><label class="form-label">Valor Pago (R$)</label><input class="input" type="number" id="pay-amount" placeholder="0,00" step="0.01"/></div>
      <div class="form-field"><label class="form-label">Comprovante (upload)</label><input class="input" type="file" id="pay-receipt" accept="image/*,.pdf"/></div>
      <div class="form-field"><label class="form-label">Observa√ß√£o</label><textarea class="textarea-input" id="pay-obs" rows="2" placeholder="Observa√ß√µes..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('payment-modal')">Cancelar</button><button class="btn btn-success" onclick="savePayment()">‚úì Confirmar Pagamento</button></div>
  </div>
</div>

<!-- Renegotiation Modal -->
<div class="modal-overlay" id="renegotiation-modal">
  <div class="modal">
    <div class="modal-header"><h2>Renegociar Parcelas</h2><button class="modal-close" onclick="closeModal('renegotiation-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="reneg-parcela-id"/>
      <div style="background:var(--amber-bg);border:1px solid rgba(217,119,6,.2);border-radius:var(--r-md);padding:14px;margin-bottom:16px;font-size:13px;color:var(--amber)">‚ö†Ô∏è As parcelas pendentes ser√£o canceladas e um novo plano criado. O hist√≥rico √© mantido para auditoria.</div>
      <div class="form-field"><label class="form-label">Valor total a renegociar (R$)</label><input class="input" type="number" id="reneg-value" placeholder="0,00"/></div>
      <div class="form-row"><div class="form-field"><label class="form-label">N¬∫ de parcelas</label><input class="input" type="number" id="reneg-n" value="3" min="1"/></div><div class="form-field"><label class="form-label">Primeiro vencimento</label><input class="input" type="date" id="reneg-first-due"/></div></div>
      <div class="form-field"><label class="form-label">Motivo da renegocia√ß√£o</label><textarea class="textarea-input" id="reneg-reason" rows="2" placeholder="Ex.: acordo amig√°vel, dificuldade financeira..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('renegotiation-modal')">Cancelar</button><button class="btn" style="background:var(--amber);color:white" onclick="saveRenegotiation()">Confirmar Renegocia√ß√£o</button></div>
  </div>
</div>

<!-- Contract View Modal -->
<div class="modal-overlay" id="contract-view-modal">
  <div class="modal modal-xl">
    <div class="modal-header">
      <h2 id="contract-view-title">Contrato</h2>
      <div style="display:flex;gap:8px;margin-right:8px">
        <button class="btn btn-outline btn-sm" onclick="downloadContractPDF()">‚Üì PDF</button>
        <button class="btn btn-navy btn-sm" onclick="regenerateContract()">+ Nova Vers√£o</button>
      </div>
      <button class="modal-close" onclick="closeModal('contract-view-modal')">‚úï</button>
    </div>
    <div class="modal-body"><div class="contract-preview" id="contract-preview-content"></div></div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal-overlay" id="template-modal">
  <div class="modal modal-lg">
    <div class="modal-header"><h2>Editor de Template de Contrato</h2><button class="modal-close" onclick="closeModal('template-modal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-field"><label class="form-label">Nome do Template</label><input class="input" type="text" id="tmpl-name" placeholder="Ex.: Contrato INSS Padr√£o"/></div><div class="form-field"><label class="form-label">Tipo de Servi√ßo</label><select class="select-input" id="tmpl-service"><option>Assessoria INSS</option><option>Confec√ß√£o de Documentos</option><option>Procura√ß√£o</option><option>Outro</option></select></div></div>
      <div class="form-field">
        <label class="form-label">Conte√∫do do Contrato</label>
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Vari√°veis dispon√≠veis: {{CLIENTE_NOME}} {{CLIENTE_CPF}} {{CLIENTE_ENDERECO}} {{SERVICO}} {{VALOR_TOTAL}} {{FORMA_PAGAMENTO}} {{DATA_HOJE}}</div>
        <textarea class="textarea-input" id="tmpl-content" rows="12" placeholder="CL√ÅUSULA 1 ‚Äì DO OBJETO..."></textarea>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('template-modal')">Cancelar</button><button class="btn btn-navy" onclick="saveTemplate()">Salvar Template</button></div>
  </div>
</div>

<!-- User Modal -->
<div class="modal-overlay" id="user-modal">
  <div class="modal">
    <div class="modal-header"><h2 id="user-modal-title">Novo Usu√°rio</h2><button class="modal-close" onclick="closeModal('user-modal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="u-id"/>
      <div class="form-field"><label class="form-label">Nome completo <span>*</span></label><input class="input" type="text" id="u-name" placeholder="Nome do usu√°rio"/></div>
      <div class="form-field"><label class="form-label">E-mail <span>*</span></label><input class="input" type="email" id="u-email" placeholder="email@bimat.com.br"/></div>
      <div class="form-row">
        <div class="form-field"><label class="form-label">Perfil / Fun√ß√£o</label><select class="select-input" id="u-role"><option value="admin">Admin</option><option value="gestor">Gestor</option><option value="operacional">Operacional</option><option value="comercial">Comercial</option><option value="financeiro">Financeiro</option><option value="leitura">Leitura</option></select></div>
        <div class="form-field" id="u-pass-group"><label class="form-label">Senha inicial <span>*</span></label><input class="input" type="password" id="u-pass" placeholder="M√≠nimo 6 caracteres"/></div>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-top:4px;line-height:1.5">üí° Com Firebase ativo, o usu√°rio ser√° criado no Firebase Authentication e poder√° fazer login imediatamente. Em modo demo, o usu√°rio √© salvo localmente.</p>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('user-modal')">Cancelar</button><button class="btn btn-navy" onclick="saveUser()">Salvar Usu√°rio</button></div>
  </div>
</div>

<!-- Client Detail Modal -->
<div class="modal-overlay" id="client-detail-modal">
  <div class="modal modal-xl">
    <div class="modal-header">
      <h2 id="cd-title">Ficha do Cliente</h2>
      <div style="display:flex;gap:8px;margin-right:8px"><button class="btn btn-outline btn-sm" onclick="editClientFromDetail()">Editar</button><button class="btn btn-navy btn-sm" onclick="newProposalForClient()">Nova Proposta</button></div>
      <button class="modal-close" onclick="closeModal('client-detail-modal')">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0">
      <div style="display:grid;grid-template-columns:1fr 1fr;min-height:400px">
        <div style="padding:24px;border-right:1px solid var(--border);overflow-y:auto">
          <div id="cd-personal"></div>
          <div class="divider"></div>
          <h4 style="font-size:15px;color:var(--navy);margin-bottom:14px">Hist√≥rico de Intera√ß√µes</h4>
          <ul class="timeline" id="cd-timeline"></ul>
          <div style="margin-top:14px;display:flex;gap:8px"><input class="input" type="text" id="cd-new-note" placeholder="Adicionar anota√ß√£o..."/><button class="btn btn-outline btn-sm" onclick="addClientNote()">+</button></div>
        </div>
        <div style="padding:24px;overflow-y:auto">
          <h4 style="font-size:15px;color:var(--navy);margin-bottom:14px">Propostas</h4>
          <div id="cd-proposals"></div>
          <div class="divider"></div>
          <h4 style="font-size:15px;color:var(--navy);margin-bottom:14px">Processos INSS</h4>
          <div id="cd-processes"></div>
          <div class="divider"></div>
          <h4 style="font-size:15px;color:var(--navy);margin-bottom:14px">Resumo Financeiro</h4>
          <div id="cd-financial"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS FOR USER / PAYMENT / RENEGOTIATION / CONTRACT VIEW / TEMPLATE / CLIENT DETAIL already included above -->

<script>
// =================== FIREBASE CONFIG ===================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCdMU-WFapAM0PW59o7laToWvhqZHpcqkM",
  authDomain: "crm-bimat.firebaseapp.com",
  projectId: "crm-bimat",
  storageBucket: "crm-bimat.firebasestorage.app",
  messagingSenderId: "631604580761",
  appId: "1:631604580761:web:fdc867c8cfbb7af3e70308"
};
const USE_DEMO = false;
let currentUser = null, currentUserData = null, db = null, auth = null, storage = null;
let charts = {};
const STORE = {
  clients: JSON.parse(localStorage.getItem('bimat_clients') || '[]'),
  proposals: JSON.parse(localStorage.getItem('bimat_proposals') || '[]'),
  contracts: JSON.parse(localStorage.getItem('bimat_contracts') || '[]'),
  processes: JSON.parse(localStorage.getItem('bimat_processes') || '[]'),
  parcelas: JSON.parse(localStorage.getItem('bimat_parcelas') || '[]'),
  tasks: JSON.parse(localStorage.getItem('bimat_tasks') || '[]'),
  users: JSON.parse(localStorage.getItem('bimat_users') || '[]'),
  templates: JSON.parse(localStorage.getItem('bimat_templates') || '[]'),
  audit: JSON.parse(localStorage.getItem('bimat_audit') || '[]'),
};
function saveStore(key) { localStorage.setItem('bimat_' + key, JSON.stringify(STORE[key])); }

function seedDemoData() {
  if (STORE.clients.length > 0) return;
  STORE.clients = [
    {id:'c1',name:'Maria Aparecida Silva',cpf:'123.456.789-00',phone:'(11) 99999-1111',email:'maria@email.com',city:'S√£o Paulo',state:'SP',origin:'WhatsApp',birth:'1958-03-15',createdAt:'2024-11-01T10:00:00.000Z',obs:'Aposentadoria por idade rural'},
    {id:'c2',name:'Jo√£o Carlos Oliveira',cpf:'987.654.321-00',phone:'(11) 98888-2222',email:'joao@email.com',city:'Campinas',state:'SP',origin:'Google',createdAt:'2024-11-15T10:00:00.000Z',obs:'BPC/LOAS para filha com defici√™ncia'},
    {id:'c3',name:'Ana Paula Costa',cpf:'111.222.333-00',phone:'(11) 97777-3333',email:'ana@email.com',city:'Santos',state:'SP',origin:'Indica√ß√£o',createdAt:'2024-12-05T10:00:00.000Z',obs:'Aux√≠lio-doen√ßa por afastamento'},
    {id:'c4',name:'Francisco Alves',cpf:'444.555.666-00',phone:'(11) 96666-4444',email:'francisco@email.com',city:'Guarulhos',state:'SP',origin:'Instagram',createdAt:'2025-01-10T10:00:00.000Z',obs:'Pens√£o por morte do c√¥njuge'},
    {id:'c5',name:'Ros√¢ngela Mendes',cpf:'777.888.999-00',phone:'(11) 95555-5555',email:'rosa@email.com',city:'Osasco',state:'SP',origin:'WhatsApp',createdAt:'2025-02-02T10:00:00.000Z',obs:'Revis√£o de benef√≠cio'},
  ];
  STORE.proposals = [
    {id:'p1',clientId:'c1',clientName:'Maria Aparecida Silva',service:'Aposentadoria por Idade',scope:'Requerimento completo junto ao INSS',value:3500,payment:'avista',nParcelas:1,stage:'Contrato assinado',status:'aprovada',date:'2024-11-05',createdAt:'2024-11-05T10:00:00.000Z',obs:''},
    {id:'p2',clientId:'c2',clientName:'Jo√£o Carlos Oliveira',service:'BPC/LOAS',scope:'Requerimento BPC para filha com defici√™ncia intelectual',value:2800,payment:'parcelado',nParcelas:2,stage:'Proposta enviada',status:'enviada',date:'2024-11-20',createdAt:'2024-11-20T10:00:00.000Z',obs:''},
    {id:'p3',clientId:'c3',clientName:'Ana Paula Costa',service:'Aux√≠lio-Doen√ßa',scope:'Afastamento por LER',value:1800,payment:'avista',nParcelas:1,stage:'An√°lise t√©cnica',status:'rascunho',date:'2024-12-08',createdAt:'2024-12-08T10:00:00.000Z',obs:''},
    {id:'p4',clientId:'c4',clientName:'Francisco Alves',service:'Pens√£o por Morte',scope:'Pens√£o por morte do c√¥njuge - casados h√° 25 anos',value:3200,payment:'entrada',nParcelas:3,entrada:800,stage:'Processo protocolado',status:'aprovada',date:'2025-01-12',createdAt:'2025-01-12T10:00:00.000Z',obs:''},
    {id:'p5',clientId:'c5',clientName:'Ros√¢ngela Mendes',service:'Revis√£o de Benef√≠cio',scope:'Revis√£o do valor da aposentadoria',value:1500,payment:'parcelado',nParcelas:3,stage:'Em atendimento',status:'rascunho',date:'2025-02-05',createdAt:'2025-02-05T10:00:00.000Z',obs:''},
    {id:'p6',clientId:'c1',clientName:'Maria Aparecida Silva',service:'Procura√ß√£o',scope:'Procura√ß√£o para representa√ß√£o junto ao INSS',value:350,payment:'avista',nParcelas:1,stage:'Encerrado',status:'aprovada',date:'2024-11-01',createdAt:'2024-11-01T10:00:00.000Z',obs:''},
  ];
  STORE.processes = [
    {id:'pr1',clientId:'c1',clientName:'Maria Aparecida Silva',type:'Aposentadoria por Idade',protocol:'1234567-89.2024.0.00.0000',reqDate:'2024-11-10',status:'Deferido',deadline:'2025-01-10',responsible:'Ana Silva',createdAt:'2024-11-10T10:00:00.000Z',checklist:[{text:'CNIS',done:true},{text:'RG/CPF',done:true},{text:'Comprovante Resid√™ncia',done:true},{text:'Carteira de Trabalho',done:true}],obs:'Processo deferido. Benef√≠cio liberado.'},
    {id:'pr2',clientId:'c2',clientName:'Jo√£o Carlos Oliveira',type:'BPC/LOAS',protocol:'9876543-21.2024.0.00.0000',reqDate:'2024-10-20',status:'Exig√™ncia',deadline:'2025-03-20',responsible:'Carlos Santos',createdAt:'2024-10-20T10:00:00.000Z',checklist:[{text:'Laudo M√©dico',done:false},{text:'Relat√≥rio Social',done:false},{text:'Comprovante de Renda',done:true},{text:'RG/CPF',done:true}],obs:'INSS solicitou laudo m√©dico complementar'},
    {id:'pr3',clientId:'c4',clientName:'Francisco Alves',type:'Pens√£o por Morte',protocol:'5555555-55.2025.0.00.0000',reqDate:'2025-01-15',status:'Em an√°lise',deadline:'2025-04-15',responsible:'Ana Silva',createdAt:'2025-01-15T10:00:00.000Z',checklist:[{text:'Certid√£o de √ìbito',done:true},{text:'Certid√£o de Casamento',done:true},{text:'CNIS',done:false},{text:'RG/CPF',done:true}],obs:''},
  ];
  STORE.parcelas = [
    {id:'pa1',clientId:'c1',clientName:'Maria Aparecida Silva',proposalId:'p1',service:'Aposentadoria por Idade',parcela:'1/1',value:3500,due:'2024-11-30',status:'Paga',paidAt:'2024-11-28',payMethod:'Pix',createdAt:'2024-11-05T10:00:00.000Z'},
    {id:'pa2',clientId:'c1',clientName:'Maria Aparecida Silva',proposalId:'p6',service:'Procura√ß√£o',parcela:'1/1',value:350,due:'2024-11-10',status:'Paga',paidAt:'2024-11-10',payMethod:'Pix',createdAt:'2024-11-01T10:00:00.000Z'},
    {id:'pa3',clientId:'c2',clientName:'Jo√£o Carlos Oliveira',proposalId:'p2',service:'BPC/LOAS',parcela:'1/2',value:1400,due:'2024-12-20',status:'Paga',paidAt:'2024-12-19',payMethod:'Transfer√™ncia',createdAt:'2024-11-20T10:00:00.000Z'},
    {id:'pa4',clientId:'c2',clientName:'Jo√£o Carlos Oliveira',proposalId:'p2',service:'BPC/LOAS',parcela:'2/2',value:1400,due:'2025-01-20',status:'Atrasada',createdAt:'2024-11-20T10:00:00.000Z'},
    {id:'pa5',clientId:'c4',clientName:'Francisco Alves',proposalId:'p4',service:'Pens√£o por Morte',parcela:'Entrada',value:800,due:'2025-01-15',status:'Paga',paidAt:'2025-01-14',payMethod:'Pix',createdAt:'2025-01-12T10:00:00.000Z'},
    {id:'pa6',clientId:'c4',clientName:'Francisco Alves',proposalId:'p4',service:'Pens√£o por Morte',parcela:'1/3',value:800,due:'2025-02-15',status:'Aberta',createdAt:'2025-01-12T10:00:00.000Z'},
    {id:'pa7',clientId:'c4',clientName:'Francisco Alves',proposalId:'p4',service:'Pens√£o por Morte',parcela:'2/3',value:800,due:'2025-03-15',status:'Aberta',createdAt:'2025-01-12T10:00:00.000Z'},
    {id:'pa8',clientId:'c4',clientName:'Francisco Alves',proposalId:'p4',service:'Pens√£o por Morte',parcela:'3/3',value:800,due:'2025-04-15',status:'Aberta',createdAt:'2025-01-12T10:00:00.000Z'},
  ];
  const t0 = new Date(); const t3 = new Date(Date.now()+86400000*3); const tm1 = new Date(Date.now()-86400000); const tm2 = new Date(Date.now()-86400000*2); const t7 = new Date(Date.now()+86400000*7);
  STORE.tasks = [
    {id:'t1',title:'Coletar laudos m√©dicos ‚Äî Jo√£o Carlos',clientName:'Jo√£o Carlos Oliveira',responsible:'Carlos Santos',priority:'alta',due:t0.toISOString().split('T')[0],status:'pendente',desc:'Prazo urgente para envio dos laudos complementares',createdAt:new Date().toISOString()},
    {id:'t2',title:'Enviar c√≥pia do contrato assinado ‚Äî Maria',clientName:'Maria Aparecida Silva',responsible:'Ana Silva',priority:'media',due:t3.toISOString().split('T')[0],status:'pendente',desc:'',createdAt:new Date().toISOString()},
    {id:'t3',title:'Analisar CNIS ‚Äî Francisco',clientName:'Francisco Alves',responsible:'Ana Silva',priority:'baixa',due:t7.toISOString().split('T')[0],status:'pendente',desc:'Verificar tempo de contribui√ß√£o',createdAt:new Date().toISOString()},
    {id:'t4',title:'Follow-up proposta ‚Äî Ros√¢ngela',clientName:'Ros√¢ngela Mendes',responsible:'Carlos Santos',priority:'media',due:tm1.toISOString().split('T')[0],status:'pendente',desc:'Ligar para confirmar aprova√ß√£o',createdAt:new Date().toISOString()},
    {id:'t5',title:'Protocolar recurso INSS ‚Äî Ana Paula',clientName:'Ana Paula Costa',responsible:'Ana Silva',priority:'alta',due:tm2.toISOString().split('T')[0],status:'pendente',desc:'Prazo de recurso vencendo',createdAt:new Date().toISOString()},
  ];
  STORE.users = [
    {id:'u1',name:'Admin BIMAT',email:'admin@bimat.com.br',role:'admin',status:'ativo',lastAccess:new Date().toISOString()},
    {id:'u2',name:'Ana Silva',email:'ana@bimat.com.br',role:'operacional',status:'ativo',lastAccess:new Date().toISOString()},
    {id:'u3',name:'Carlos Santos',email:'carlos@bimat.com.br',role:'comercial',status:'ativo',lastAccess:new Date(Date.now()-86400000).toISOString()},
    {id:'u4',name:'Financeiro BIMAT',email:'fin@bimat.com.br',role:'financeiro',status:'ativo',lastAccess:new Date(Date.now()-3600000*5).toISOString()},
  ];
  STORE.templates = [
    {id:'tmpl1',name:'Contrato Assessoria INSS',service:'Assessoria INSS',content:'CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS\n\nCL√ÅUSULA 1 ‚Äì DAS PARTES\nCONTRATADA: BIMAT Solu√ß√µes Jur√≠dicas.\nCONTRATANTE: {{CLIENTE_NOME}}, CPF {{CLIENTE_CPF}}, residente em {{CLIENTE_ENDERECO}}.\n\nCL√ÅUSULA 2 ‚Äì DO OBJETO\nA CONTRATADA realizar√° {{SERVICO}} perante o INSS, em nome do CONTRATANTE, compreendendo an√°lise documental, orienta√ß√£o, prepara√ß√£o e protocolo do requerimento.\n\nCL√ÅUSULA 3 ‚Äì DA REMUNERA√á√ÉO\nO CONTRATANTE pagar√° {{VALOR_TOTAL}}, na forma {{FORMA_PAGAMENTO}}.\n\nCL√ÅUSULA 4 ‚Äì DAS OBRIGA√á√ïES DA CONTRATADA\nA CONTRATADA se obriga a conduzir o processo com dilig√™ncia, manter o CONTRATANTE informado e guardar sigilo sobre seus dados.\n\nCL√ÅUSULA 5 ‚Äì DAS OBRIGA√á√ïES DO CONTRATANTE\nO CONTRATANTE se obriga a fornecer documentos solicitados e efetuar pagamentos na forma acordada.\n\nCL√ÅUSULA 6 ‚Äì DO FORO\nForo da Comarca de S√£o Paulo/SP.\n\nS√£o Paulo, {{DATA_HOJE}}.',createdAt:new Date().toISOString()},
    {id:'tmpl2',name:'Procura√ß√£o para o INSS',service:'Procura√ß√£o',content:'PROCURA√á√ÉO AD NEGOTIA\n\nOUTORGANTE: {{CLIENTE_NOME}}, CPF {{CLIENTE_CPF}}, residente em {{CLIENTE_ENDERECO}}.\n\nOUTORGADA: BIMAT Solu√ß√µes Jur√≠dicas.\n\nPelo presente instrumento, o OUTORGANTE nomeia e constitui a OUTORGADA como sua bastante procurat√≥ria para represent√°-lo perante o INSS em tudo que se referir a {{SERVICO}}.\n\nS√£o Paulo, {{DATA_HOJE}}.\n\n________________________\n{{CLIENTE_NOME}}\nCPF: {{CLIENTE_CPF}}',createdAt:new Date().toISOString()},
  ];
  ['clients','proposals','processes','parcelas','tasks','users','templates'].forEach(k=>saveStore(k));
}

// =================== FIREBASE ===================
function initFirebase() {
  if (USE_DEMO) return;
  try { if (firebase.apps.length===0) firebase.initializeApp(FIREBASE_CONFIG); auth=firebase.auth(); db=firebase.firestore(); storage=firebase.storage(); } catch(e) { console.warn('Firebase init:', e.message); }
}

// =================== FIRESTORE HELPERS (BIMAT single-tenant) ===================
function isFirestoreReady(){
  return (!USE_DEMO) && !!db && !!auth && !!currentUser;
}
function _toISO(v){
  // Firestore Timestamp -> ISO; Date -> ISO; string -> string
  if(!v) return v;
  try{
    if (typeof v === 'string') return v;
    if (v instanceof Date) return v.toISOString();
    // compat Timestamp has toDate()
    if (typeof v.toDate === 'function') return v.toDate().toISOString();
  }catch(e){}
  return v;
}
function _normalizeClient(docId, data){
  const d = data || {};
  return {
    id: docId,
    ...d,
    createdAt: _toISO(d.createdAt) || new Date().toISOString(),
    updatedAt: _toISO(d.updatedAt) || new Date().toISOString(),
  };
}
async function fsClients_list(){
  const snap = await db.collection('clients').orderBy('createdAt','desc').get();
  return snap.docs.map(d => _normalizeClient(d.id, d.data()));
}
async function fsClients_upsert(client){
  const now = new Date();
  const id = client.id;
  const payload = {
    ...client,
    createdAt: client.createdAt || now.toISOString(),
    updatedAt: now.toISOString(),
  };
  await db.collection('clients').doc(id).set(payload, { merge:true });
  return _normalizeClient(id, payload);
}
async function fsClients_create(client){
  const now = new Date();
  const payload = {
    ...client,
    createdAt: client.createdAt || now.toISOString(),
    updatedAt: now.toISOString(),
  };
  const ref = await db.collection('clients').add(payload);
  return _normalizeClient(ref.id, payload);
}
async function fsClients_delete(id){
  await db.collection('clients').doc(id).delete();
  return true;
}


// =================== FIRESTORE: PROPOSTAS & PARCELAS ===================
function _normalizeProposal(docId, data){
  const d = data || {};
  return {
    id: docId,
    ...d,
    createdAt: _toISO(d.createdAt) || new Date().toISOString(),
    updatedAt: _toISO(d.updatedAt) || new Date().toISOString(),
  };
}
async function fsProposals_list(){
  const snap = await db.collection('proposals').orderBy('createdAt','desc').get();
  return snap.docs.map(d => _normalizeProposal(d.id, d.data()));
}
async function fsProposals_upsert(prop){
  const now = new Date();
  const id = prop.id;
  const payload = {
    ...prop,
    createdAt: prop.createdAt || now.toISOString(),
    updatedAt: now.toISOString(),
  };
  await db.collection('proposals').doc(id).set(payload, { merge:true });
  return _normalizeProposal(id, payload);
}
async function fsProposals_delete(id){
  await db.collection('proposals').doc(id).delete();
  return true;
}

function _normalizeParcela(docId, data){
  const d = data || {};
  return {
    id: docId,
    ...d,
    createdAt: _toISO(d.createdAt) || new Date().toISOString(),
    updatedAt: _toISO(d.updatedAt) || new Date().toISOString(),
  };
}
async function fsParcelas_list(){
  const snap = await db.collection('parcelas').orderBy('due','asc').get();
  return snap.docs.map(d => _normalizeParcela(d.id, d.data()));
}
async function fsParcelas_deleteByProposal(proposalId){
  const snap = await db.collection('parcelas').where('proposalId','==',proposalId).get();
  if (snap.empty) return 0;
  const batch = db.batch();
  let count = 0;
  snap.docs.forEach(doc=>{
    batch.delete(doc.ref);
    count++;
  });
  await batch.commit();
  return count;
}
async function fsParcelas_upsertMany(parcelas){
  const batch = db.batch();
  const now = new Date().toISOString();
  parcelas.forEach(p=>{
    const id = p.id || ('pa'+Date.now()+Math.random().toString(36).slice(2,6));
    const ref = db.collection('parcelas').doc(id);
    batch.set(ref, { ...p, id, updatedAt: now, createdAt: p.createdAt || now }, { merge:true });
  });
  await batch.commit();
  return true;
}
async function fsParcelas_upsert(parcela){
  const now = new Date().toISOString();
  const payload = { ...parcela, updatedAt: now, createdAt: parcela.createdAt||now };
  await db.collection('parcelas').doc(parcela.id).set(payload, { merge:true });
  return payload;
}

// Helper: garante que STORE.proposals / STORE.parcelas est√£o em mem√≥ria (Firestore -> STORE)
async function ensureProposalsLoaded(){
  if (!isFirestoreReady()) return;
  STORE.proposals = await fsProposals_list();
  localStorage.setItem('bimat_proposals', JSON.stringify(STORE.proposals));
}
async function ensureParcelasLoaded(){
  if (!isFirestoreReady()) return;
  STORE.parcelas = await fsParcelas_list();
  localStorage.setItem('bimat_parcelas', JSON.stringify(STORE.parcelas));
}

// =================== FIRESTORE: PROCESSOS ===================
function _normalizeProcess(docId, data){
  const d = data || {};
  return { id: docId, ...d, createdAt: _toISO(d.createdAt)||new Date().toISOString(), updatedAt: _toISO(d.updatedAt)||new Date().toISOString() };
}
async function fsProcesses_list(){
  const snap = await db.collection('processes').orderBy('createdAt','desc').get();
  return snap.docs.map(d => _normalizeProcess(d.id, d.data()));
}
async function fsProcesses_upsert(proc){
  const now = new Date().toISOString();
  const payload = { ...proc, updatedAt: now, createdAt: proc.createdAt||now };
  await db.collection('processes').doc(proc.id).set(payload, { merge:true });
  return _normalizeProcess(proc.id, payload);
}
async function fsProcesses_delete(id){
  await db.collection('processes').doc(id).delete();
  return true;
}
async function ensureProcessesLoaded(){
  if (!isFirestoreReady()) return;
  STORE.processes = await fsProcesses_list();
  localStorage.setItem('bimat_processes', JSON.stringify(STORE.processes));
}

// =================== FIRESTORE: TAREFAS ===================
function _normalizeTask(docId, data){
  const d = data || {};
  return { id: docId, ...d, createdAt: _toISO(d.createdAt)||new Date().toISOString() };
}
async function fsTasks_list(){
  const snap = await db.collection('tasks').orderBy('due','asc').get();
  return snap.docs.map(d => _normalizeTask(d.id, d.data()));
}
async function fsTasks_upsert(task){
  const now = new Date().toISOString();
  const payload = { ...task, updatedAt: now, createdAt: task.createdAt||now };
  await db.collection('tasks').doc(task.id).set(payload, { merge:true });
  return _normalizeTask(task.id, payload);
}
async function fsTasks_delete(id){
  await db.collection('tasks').doc(id).delete();
  return true;
}
async function ensureTasksLoaded(){
  if (!isFirestoreReady()) return;
  STORE.tasks = await fsTasks_list();
  localStorage.setItem('bimat_tasks', JSON.stringify(STORE.tasks));
}

// =================== FIRESTORE: USU√ÅRIOS ===================
function _normalizeUser(docId, data){
  const d = data || {};
  return { id: docId, ...d, createdAt: _toISO(d.createdAt)||new Date().toISOString() };
}
async function fsUsers_list(){
  const snap = await db.collection('users').orderBy('createdAt','asc').get();
  return snap.docs.map(d => _normalizeUser(d.id, d.data()));
}
async function fsUsers_upsert(user){
  const now = new Date().toISOString();
  const payload = { ...user, updatedAt: now, createdAt: user.createdAt||now };
  await db.collection('users').doc(user.id).set(payload, { merge:true });
  return _normalizeUser(user.id, payload);
}
async function fsUsers_delete(id){
  await db.collection('users').doc(id).delete();
  return true;
}
async function ensureUsersLoaded(){
  if (!isFirestoreReady()) return;
  STORE.users = await fsUsers_list();
  localStorage.setItem('bimat_users', JSON.stringify(STORE.users));
}

// =================== FIRESTORE: CONTRATOS ===================
function _normalizeContract(docId, data){
  const d = data || {};
  return { id: docId, ...d, createdAt: _toISO(d.createdAt)||new Date().toISOString(), updatedAt: _toISO(d.updatedAt)||new Date().toISOString() };
}
async function fsContracts_list(){
  const snap = await db.collection('contracts').orderBy('createdAt','desc').get();
  return snap.docs.map(d => _normalizeContract(d.id, d.data()));
}
async function fsContracts_upsert(contract){
  const now = new Date().toISOString();
  const payload = { ...contract, updatedAt: now, createdAt: contract.createdAt||now };
  await db.collection('contracts').doc(contract.id).set(payload, { merge:true });
  return _normalizeContract(contract.id, payload);
}
async function fsContracts_delete(id){
  await db.collection('contracts').doc(id).delete();
}
async function ensureContractsLoaded(){
  if (!isFirestoreReady()) return;
  STORE.contracts = await fsContracts_list();
  localStorage.setItem('bimat_contracts', JSON.stringify(STORE.contracts));
}

// =================== FIRESTORE: TEMPLATES ===================
function _normalizeTemplate(docId, data){
  const d = data || {};
  return { id: docId, ...d, createdAt: _toISO(d.createdAt)||new Date().toISOString() };
}
async function fsTemplates_list(){
  const snap = await db.collection('templates').orderBy('createdAt','asc').get();
  return snap.docs.map(d => _normalizeTemplate(d.id, d.data()));
}
async function fsTemplates_upsert(template){
  const now = new Date().toISOString();
  const payload = { ...template, updatedAt: now, createdAt: template.createdAt||now };
  await db.collection('templates').doc(template.id).set(payload, { merge:true });
  return _normalizeTemplate(template.id, payload);
}
async function fsTemplates_delete(id){
  await db.collection('templates').doc(id).delete();
}
async function ensureTemplatesLoaded(){
  if (!isFirestoreReady()) return;
  STORE.templates = await fsTemplates_list();
  localStorage.setItem('bimat_templates', JSON.stringify(STORE.templates));
}

// =================== FIRESTORE: PERMISS√ïES CUSTOMIZADAS ===================
// Permiss√µes padr√£o por perfil (V=visualizar, C=criar/editar, D=excluir)
const DEFAULT_PERMISSIONS = {
  admin:      { clients:['V','C','D'], proposals:['V','C','D'], contracts:['V','C','D'], processes:['V','C','D'], financial:['V','C','D'], tasks:['V','C','D'], reports:['V','C','D'], users:['V','C','D'] },
  gestor:     { clients:['V','C','D'], proposals:['V','C','D'], contracts:['V','C','D'], processes:['V','C','D'], financial:['V','C','D'], tasks:['V','C','D'], reports:['V','C','D'], users:['V'] },
  operacional:{ clients:['V','C'],     proposals:['V','C'],     contracts:['V'],         processes:['V','C'],     financial:['V'],         tasks:['V','C'],     reports:['V'],         users:[] },
  comercial:  { clients:['V','C'],     proposals:['V','C','D'], contracts:['V'],         processes:['V'],         financial:['V'],         tasks:['V','C'],     reports:['V'],         users:[] },
  financeiro: { clients:['V'],         proposals:['V'],         contracts:['V'],         processes:['V'],         financial:['V','C','D'], tasks:['V'],         reports:['V'],         users:[] },
  leitura:    { clients:['V'],         proposals:['V'],         contracts:['V'],         processes:['V'],         financial:['V'],         tasks:['V'],         reports:['V'],         users:[] },
};
let CUSTOM_PERMISSIONS = JSON.parse(localStorage.getItem('bimat_permissions')||'null') || null;

function getPermissions(){ return CUSTOM_PERMISSIONS || DEFAULT_PERMISSIONS; }
function userCan(action, module){
  const role = currentUserData?.role || 'leitura';
  const perms = getPermissions();
  const rolePerms = perms[role] || perms['leitura'];
  const modulePerms = rolePerms[module] || [];
  return modulePerms.includes(action);
}
function userCanView(module){ return currentUserData?.role==='admin' || userCan('V', module); }

async function savePermissionsToFirestore(perms){
  if(isFirestoreReady()){
    try{ await db.collection('config').doc('permissions').set({data: JSON.stringify(perms), updatedAt: new Date().toISOString()}); }
    catch(e){ console.warn('Permissions Firestore:', e.message); }
  }
  localStorage.setItem('bimat_permissions', JSON.stringify(perms));
  CUSTOM_PERMISSIONS = perms;
}
async function loadPermissionsFromFirestore(){
  if(!isFirestoreReady()) return;
  try{
    const snap = await db.collection('config').doc('permissions').get();
    if(snap.exists){
      CUSTOM_PERMISSIONS = JSON.parse(snap.data().data);
      localStorage.setItem('bimat_permissions', JSON.stringify(CUSTOM_PERMISSIONS));
    }
  }catch(e){ console.warn('loadPermissions:', e.message); }
}

// =================== AUTH ===================
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.classList.remove('show');

  if (!email || !pass) {
    errEl.textContent = 'Preencha e-mail e senha.';
    errEl.classList.add('show');
    return;
  }

  const btn     = document.getElementById('login-btn');
  const btnText = document.getElementById('login-btn-text');
  btn.disabled  = true;
  btnText.innerHTML = '<span class="spinner"></span> Entrando...';

  try {
    if (USE_DEMO || !auth) {
      // ---- MODO DEMO / offline ----
      const ok = (email==='admin@bimat.com.br' && pass==='bimat2024')
               || STORE.users.find(u => u.email===email);
      if (!ok) throw new Error('Credenciais inv√°lidas. Demo: admin@bimat.com.br / bimat2024');
      const u = STORE.users.find(x => x.email===email)
              || {id:'admin', name:'Admin BIMAT', email, role:'admin'};
      currentUser     = {uid: u.id, email: u.email};
      currentUserData = u;
      sessionStorage.setItem('bimat_session', JSON.stringify(currentUser));
      await onLogin();

    } else {
      // ---- FIREBASE AUTH ----
      let uc;
      try {
        uc = await auth.signInWithEmailAndPassword(email, pass);
      } catch(authErr) {
        const msgs = {
          'auth/user-not-found':    'E-mail n√£o cadastrado.',
          'auth/wrong-password':    'Senha incorreta.',
          'auth/invalid-credential':'E-mail ou senha incorretos.',
          'auth/invalid-email':     'E-mail inv√°lido.',
          'auth/too-many-requests': 'Muitas tentativas. Tente novamente em alguns minutos.',
          'auth/network-request-failed': 'Sem conex√£o com a internet.',
          'auth/user-disabled':     'Usu√°rio desativado.',
        };
        throw new Error(msgs[authErr.code] || authErr.message);
      }

      currentUser = uc.user;

      // Busca dados do perfil no Firestore (n√£o obrigat√≥rio ‚Äî pode n√£o existir ainda)
      let userData = null;
      try {
        const snap = await db.collection('users').doc(currentUser.uid).get();
        userData = snap.exists ? snap.data() : null;
      } catch(fsErr) {
        console.warn('Firestore users read:', fsErr.message);
      }

      // Se n√£o tem documento no Firestore, cria um (primeiro login do admin)
      if (!userData) {
        const isKnownAdmin = email === 'admin@bimat.com.br';
        userData = {
          id: currentUser.uid,
          uid: currentUser.uid,
          name: isKnownAdmin ? 'Admin BIMAT' : email.split('@')[0],
          email: currentUser.email,
          role: isKnownAdmin ? 'admin' : 'operacional',
          status: 'ativo',
          createdAt: new Date().toISOString(),
          lastAccess: new Date().toISOString(),
        };
        try {
          await db.collection('users').doc(currentUser.uid).set(userData);
          STORE.users.push(userData);
          localStorage.setItem('bimat_users', JSON.stringify(STORE.users));
        } catch(e) {
          console.warn('N√£o foi poss√≠vel criar perfil no Firestore:', e.message);
        }
      } else {
        // Atualiza lastAccess
        try {
          await db.collection('users').doc(currentUser.uid).update({ lastAccess: new Date().toISOString() });
        } catch(e) {}
      }

      currentUserData = userData;
      sessionStorage.setItem('bimat_session', JSON.stringify({uid: currentUser.uid, email: currentUser.email}));
      await onLogin();
    }

  } catch(e) {
    errEl.textContent = e.message || 'Erro desconhecido. Tente novamente.';
    errEl.classList.add('show');
    console.error('doLogin error:', e);
  } finally {
    btn.disabled = false;
    btnText.textContent = 'Entrar no CRM';
  }
}

function doForgotPassword() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) { showToast('Digite seu e-mail primeiro.','warning'); return; }
  if (auth) auth.sendPasswordResetEmail(email).then(()=>showToast('E-mail enviado!','success')).catch(e=>showToast(e.message,'error'));
  else showToast('Configure o Firebase para usar esta fun√ß√£o.','warning');
}

async function onLogin() {
  document.getElementById('login-page').classList.remove('active');
  document.getElementById('login-page').style.display='none';
  document.getElementById('app').style.display='flex';

  if (USE_DEMO) {
    seedDemoData();
  } else {
    try {
      await loadPermissionsFromFirestore();
      const [clients, proposals, parcelas, processes, tasks, users, contracts, templates] = await Promise.all([
        fsClients_list().catch(e=>{console.warn('clients:',e.message);return STORE.clients;}),
        fsProposals_list().catch(e=>{console.warn('proposals:',e.message);return STORE.proposals;}),
        fsParcelas_list().catch(e=>{console.warn('parcelas:',e.message);return STORE.parcelas;}),
        fsProcesses_list().catch(e=>{console.warn('processes:',e.message);return STORE.processes;}),
        fsTasks_list().catch(e=>{console.warn('tasks:',e.message);return STORE.tasks;}),
        fsUsers_list().catch(e=>{console.warn('users:',e.message);return STORE.users;}),
        fsContracts_list().catch(e=>{console.warn('contracts:',e.message);return STORE.contracts;}),
        fsTemplates_list().catch(e=>{console.warn('templates:',e.message);return STORE.templates;}),
      ]);
      STORE.clients=clients; STORE.proposals=proposals; STORE.parcelas=parcelas;
      STORE.processes=processes; STORE.tasks=tasks; STORE.users=users;
      STORE.contracts=contracts; STORE.templates=templates;
      if(currentUser){
        const fsUser=users.find(u=>u.id===currentUser.uid||u.email===currentUser.email);
        if(fsUser) currentUserData=fsUser;
      }
      ['clients','proposals','parcelas','processes','tasks','users','contracts','templates'].forEach(k=>localStorage.setItem('bimat_'+k,JSON.stringify(STORE[k])));
    } catch(e) {
      console.warn('Falha ao carregar do Firestore:', e.message);
    }
  }

  updateUserUI();
  applyPermissionsToNav();
  loadBadges();
  navigate('dashboard');
  showToast('Bem-vindo, ' + ((currentUserData && currentUserData.name) || 'usu√°rio') + '!','success');
}

function applyPermissionsToNav(){
  const role = currentUserData?.role || 'operacional';
  const perms = getPermissions();
  const rolePerms = perms[role] || {};
  const navMap = { clients:'clients', proposals:'proposals', contracts:'contracts', processes:'processes', tasks:'tasks', financial:'financial', reports:'reports' };
  Object.entries(navMap).forEach(([module,section])=>{
    const el = document.querySelector('.nav-item[data-section="'+section+'"]');
    if(!el) return;
    el.style.display = (role==='admin'||(rolePerms[module]||[]).includes('V')) ? '' : 'none';
  });
  const navUsers = document.getElementById('nav-users');
  if(navUsers) navUsers.style.display = role==='admin' ? '' : 'none';
}

function doLogout() {
  if (auth) auth.signOut().catch(()=>{});
  currentUser=null; currentUserData=null;
  sessionStorage.removeItem('bimat_session');
  Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});
  charts={};
  showLoginPage();
}

function updateUserUI() {
  const n=currentUserData?.name||'Usu√°rio'; const r=currentUserData?.role||'operacional';
  document.getElementById('sidebar-name').textContent=n;
  document.getElementById('sidebar-role').textContent=capitalize(r);
  document.getElementById('sidebar-avatar').textContent=n.charAt(0).toUpperCase();
  // Visibilidade de nav gerenciada por applyPermissionsToNav()
}

// =================== NAVIGATION ===================
const PAGE_TITLES={dashboard:'Dashboard',clients:'Clientes',funnel:'Funil Comercial',proposals:'Propostas',contracts:'Contratos',processes:'Processos INSS',tasks:'Tarefas',financial:'Financeiro',reports:'Relat√≥rios',users:'Usu√°rios',settings:'Configura√ß√µes'};
function navigate(section) {
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('section-'+section)?.classList.add('active');
  document.querySelector('.nav-item[data-section="'+section+'"]')?.classList.add('active');
  document.getElementById('topbar-title').textContent=PAGE_TITLES[section]||section;
  document.getElementById('topbar-breadcrumb').textContent='BIMAT CRM ‚Ä∫ '+(PAGE_TITLES[section]||section);
  loadSection(section);
}
function loadSection(s){switch(s){case 'dashboard':loadDashboard();break;case 'clients':loadClients();break;case 'funnel':loadFunnel();break;case 'proposals':loadProposals();break;case 'contracts':loadContractsSection();break;case 'processes':loadProcessesSection();break;case 'tasks':loadTasksSection();break;case 'financial':loadFinancial();break;case 'reports':initReports();break;case 'users':loadUsers();break;case 'settings':loadSettings();break;}}

async function loadContractsSection(){
  try{
    await Promise.all([ensureContractsLoaded(), ensureTemplatesLoaded()]);
  }catch(e){ console.warn('contracts Firestore:',e.message); }
  loadContracts();
}
async function loadProcessesSection(){
  try{ await ensureProcessesLoaded(); }catch(e){ console.warn('processes Firestore:',e.message); }
  loadProcesses();
}
async function loadTasksSection(){
  try{ await ensureTasksLoaded(); }catch(e){ console.warn('tasks Firestore:',e.message); }
  loadTasks();
}

// =================== DASHBOARD ===================
async function loadDashboard() {
  try{ await Promise.all([ensureProposalsLoaded(), ensureParcelasLoaded()]); }catch(e){ console.warn('loadDashboard Firestore:', e.message); }

  const todayStr=new Date().toISOString().split('T')[0];
  const approved=STORE.proposals.filter(p=>p.status==='aprovada').length;
  const totalRec=STORE.parcelas.filter(p=>p.status==='Paga').reduce((s,p)=>s+p.value,0);
  const totalAb=STORE.parcelas.filter(p=>p.status==='Aberta'||p.status==='Atrasada').reduce((s,p)=>s+p.value,0);
  const atrasadas=STORE.parcelas.filter(p=>p.status==='Atrasada').length;
  const tasksDue=STORE.tasks.filter(t=>t.status!=='concluida'&&t.due<=todayStr).length;
  document.getElementById('dash-stats').innerHTML=
    statCard('navy','Clientes Ativos',STORE.clients.length,'','<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>')+
    statCard('gold','Propostas Aprovadas',approved,'Total geral','<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>')+
    statCard('green','Recebido','R$&nbsp;'+fmt(totalRec),'Parcelas pagas','<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>')+
    statCard('red','Em Aberto','R$&nbsp;'+fmt(totalAb),atrasadas+' em atraso','<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>')+
    statCard('purple','Processos INSS',STORE.processes.length,'Ativos','<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>')+
    statCard('amber','Tarefas Urgentes',tasksDue,'Vencidas/hoje','<polyline points="9 11 12 14 22 4"/>');
  setTimeout(()=>{renderFunnelChart();renderFinancialChart();renderProcessesChart();renderLeadsChart();},50);
  renderAlerts(todayStr); renderTasksToday(todayStr);
}
function statCard(color,label,value,sub,path){return`<div class="stat-card ${color}"><div class="stat-icon ${color}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${path}</svg></div><div class="stat-value">${value}</div><div class="stat-label">${label}</div>${sub?`<div class="stat-change" style="color:var(--muted)">${sub}</div>`:''}</div>`;}
function renderAlerts(todayStr){
  const alerts=[];
  STORE.parcelas.filter(p=>p.status==='Atrasada').forEach(p=>alerts.push({c:'red',t:`üí∞ Parcela ${p.parcela} atrasada ‚Äî ${p.clientName} ‚Äî R$ ${fmt(p.value)}`}));
  STORE.processes.filter(p=>p.status==='Exig√™ncia').forEach(p=>alerts.push({c:'amber',t:`‚ö†Ô∏è Exig√™ncia INSS: ${p.type} ‚Äî ${p.clientName}${p.deadline?' ‚Äî prazo '+fmtDate(p.deadline):''}`}));
  STORE.tasks.filter(t=>t.status!=='concluida'&&t.due<todayStr).forEach(t=>alerts.push({c:'navy',t:`üìã Tarefa vencida: ${t.title}`}));
  document.getElementById('dash-alerts').innerHTML=alerts.length?alerts.map(a=>`<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)"><span style="width:8px;height:8px;border-radius:50%;background:var(--${a.c});flex-shrink:0;margin-top:5px"></span><span style="font-size:13px">${a.t}</span></div>`).join(''):'<div style="padding:30px;text-align:center;color:var(--green);font-size:14px">‚úì Nenhum alerta cr√≠tico no momento</div>';
}
function renderTasksToday(todayStr){
  const tasks=STORE.tasks.filter(t=>t.status!=='concluida'&&t.due===todayStr);
  document.getElementById('dash-tasks-today').innerHTML=tasks.length?tasks.map(t=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)"><div class="check-box" onclick="toggleTaskById('${t.id}',this)"></div><div style="flex:1"><div style="font-size:13.5px;font-weight:500">${t.title}</div><div style="font-size:12px;color:var(--muted)">${t.responsible||'‚Äî'}</div></div><span class="badge badge-${t.priority==='alta'?'red':t.priority==='media'?'amber':'green'}">${t.priority}</span></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">Nenhuma tarefa para hoje</div>';
}
async function toggleTaskById(id,el){const t=STORE.tasks.find(x=>x.id===id);if(t){t.status=t.status==='concluida'?'pendente':'concluida';el.classList.toggle('checked');if(isFirestoreReady()){try{await fsTasks_upsert(t);}catch(e){console.warn(e);}}saveStore('tasks');loadBadges();}}
function renderFunnelChart(){
  const ctx=document.getElementById('chart-funnel'); if(!ctx)return;
  if(charts.funnel)charts.funnel.destroy();
  const stages=['Lead novo','Em atendimento','Aguardando documentos','An√°lise t√©cnica','Proposta enviada','Proposta aprovada','Contrato assinado'];
  charts.funnel=new Chart(ctx,{type:'bar',data:{labels:stages.map(s=>s.length>14?s.slice(0,12)+'‚Ä¶':s),datasets:[{data:stages.map(s=>STORE.proposals.filter(p=>p.stage===s).length),backgroundColor:'rgba(11,61,107,.8)',borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});
}
function renderFinancialChart(){
  const ctx=document.getElementById('chart-financial'); if(!ctx)return;
  if(charts.fin)charts.fin.destroy();
  const months=Array.from({length:6},(_,i)=>{const d=new Date();d.setMonth(d.getMonth()-5+i);return d;});
  charts.fin=new Chart(ctx,{type:'line',data:{labels:months.map(d=>d.toLocaleDateString('pt-BR',{month:'short',year:'2-digit'})),datasets:[{label:'Recebido',data:months.map(m=>STORE.parcelas.filter(p=>p.status==='Paga'&&p.paidAt&&new Date(p.paidAt).getMonth()===m.getMonth()&&new Date(p.paidAt).getFullYear()===m.getFullYear()).reduce((s,p)=>s+p.value,0)),borderColor:'#0D9B5A',backgroundColor:'rgba(13,155,90,.1)',fill:true,tension:.4,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'R$'+fmt(v)}}}}});
}
function renderProcessesChart(){
  const ctx=document.getElementById('chart-processes'); if(!ctx)return;
  if(charts.proc)charts.proc.destroy();
  const statuses=['Em an√°lise','Exig√™ncia','Per√≠cia','Deferido','Indeferido','Recurso'];
  charts.proc=new Chart(ctx,{type:'doughnut',data:{labels:statuses,datasets:[{data:statuses.map(s=>STORE.processes.filter(p=>p.status===s).length),backgroundColor:['#0B3D6B','#D97706','#7C3AED','#0D9B5A','#DC2626','#C9A84C'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11},boxWidth:12}}}}});
}
function renderLeadsChart(){
  const ctx=document.getElementById('chart-leads'); if(!ctx)return;
  if(charts.leads)charts.leads.destroy();
  const origins=['WhatsApp','Google','Instagram','Indica√ß√£o','Outro'];
  charts.leads=new Chart(ctx,{type:'pie',data:{labels:origins,datasets:[{data:origins.map(o=>STORE.clients.filter(c=>c.origin===o).length),backgroundColor:['#25D366','#0B3D6B','#E1306C','#C9A84C','#5A6A7A'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11},boxWidth:12}}}}});
}

// =================== CLIENTS ===================
let clientsPage=1, clientsFiltered=[];
async function loadClients(){
  try{
    if (isFirestoreReady()) {
      STORE.clients = await fsClients_list();
      localStorage.setItem('bimat_clients', JSON.stringify(STORE.clients));
    }
  } catch(e){ console.warn('loadClients Firestore:', e.message); }
  clientsFiltered=[...STORE.clients];
  renderClientsTable();
}
function filterClients(v){
  v=(v||document.querySelector('#section-clients .search-box input')?.value||'').toLowerCase();
  const origin=document.getElementById('client-origin-filter')?.value||'';
  clientsFiltered=STORE.clients.filter(c=>(!v||(c.name.toLowerCase().includes(v)||c.cpf.includes(v)||(c.email||'').toLowerCase().includes(v)))&&(!origin||c.origin===origin));
  clientsPage=1; renderClientsTable();
}
function renderClientsTable(){
  const paged=paginate(clientsFiltered,clientsPage,10);
  document.getElementById('clients-tbody').innerHTML=paged.data.map(c=>`<tr>
    <td><div class="td-name" style="cursor:pointer" onclick="openClientDetail('${c.id}')">${c.name}</div><div class="td-muted">${c.cpf||'‚Äî'}</div></td>
    <td><div>${c.phone||'‚Äî'}</div><div class="td-muted">${c.email||'‚Äî'}</div></td>
    <td>${c.city||'‚Äî'}/${c.state||'‚Äî'}</td>
    <td><span class="badge badge-${originBadge(c.origin)}">${c.origin||'‚Äî'}</span></td>
    <td class="td-muted">${fmtDate(c.createdAt)}</td>
    <td><div class="td-actions">
      <div class="td-btn" onclick="openClientDetail('${c.id}')" title="Ver"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <div class="td-btn" onclick="openClientModal('${c.id}')" title="Editar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
      <div class="td-btn danger" onclick="deleteClient('${c.id}')" title="Excluir"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
    </div></td>
  </tr>`).join('')||'<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>Nenhum cliente</h3><button class="btn btn-navy" onclick="openClientModal()">Novo Cliente</button></div></td></tr>';
  document.getElementById('clients-pagination').innerHTML=renderPagination(paged,clientsPage,'setClientsPage');
}
function setClientsPage(p){clientsPage=p;renderClientsTable();}
function openClientModal(id){
  const c=id?STORE.clients.find(x=>x.id===id):null;
  document.getElementById('client-modal-title').textContent=id?'Editar Cliente':'Novo Cliente';
  document.getElementById('client-id').value=id||'';
  ['name','cpf','rg','phone','email','cep','street','number','neighborhood','complement','city','nb','obs'].forEach(f=>{const el=document.getElementById('c-'+f);if(el)el.value=c?c[f]||'':''});
  if(c){document.getElementById('c-state').value=c.state||'SP';document.getElementById('c-origin').value=c.origin||'WhatsApp';document.getElementById('c-birth').value=c.birth||'';}
  openModal('client-modal');
}
async function saveClient(){
  const idField = document.getElementById('client-id');
  const existingId = (idField && idField.value) ? idField.value : '';
  const name=document.getElementById('c-name').value.trim();
  const cpf=document.getElementById('c-cpf').value.trim();
  if(!name||!cpf){showToast('Nome e CPF s√£o obrigat√≥rios','error');return;}

  const client={
    id: existingId, // pode estar vazio; Firestore gera no create
    name,cpf,
    rg:ge('c-rg'),birth:ge('c-birth'),phone:ge('c-phone'),email:ge('c-email'),
    cep:ge('c-cep'),street:ge('c-street'),number:ge('c-number'),neighborhood:ge('c-neighborhood'),complement:ge('c-complement'),
    city:ge('c-city'),state:document.getElementById('c-state').value,
    origin:document.getElementById('c-origin').value,
    nb:ge('c-nb'),obs:ge('c-obs'),
    createdAt: (existingId ? (STORE.clients.find(c=>c.id===existingId)?.createdAt) : null) || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  try{
    if (isFirestoreReady()) {
      let saved;
      if (existingId) {
        saved = await fsClients_upsert(client);
      } else {
        // cria e recebe o ID do Firestore
        const { id, ...rest } = client;
        saved = await fsClients_create(rest);
        if (idField) idField.value = saved.id;
      }
      // atualiza o STORE local e cache
      upsert(STORE.clients, saved);
      localStorage.setItem('bimat_clients', JSON.stringify(STORE.clients));
      auditLog('client', saved.id,'save', saved.name);
    } else {
      // fallback local (demo/offline)
      const localId = existingId || ('c'+Date.now());
      client.id = localId;
      upsert(STORE.clients,client);
      saveStore('clients');
      auditLog('client',localId,'save',client.name);
    }
  } catch(e){
    console.warn('saveClient Firestore:', e.message);
    showToast('Falha ao salvar no Firestore: '+e.message,'error');
    return;
  }

  closeModal('client-modal');
  await loadClients();
  showToast('Cliente salvo!','success');
}
function ge(id){return document.getElementById(id)?.value||'';}
async function deleteClient(id){
  if(!confirm('Excluir cliente?')) return;
  try{
    if (isFirestoreReady()) {
      await fsClients_delete(id);
      STORE.clients = STORE.clients.filter(c=>c.id!==id);
      localStorage.setItem('bimat_clients', JSON.stringify(STORE.clients));
      auditLog('client',id,'delete','');
    } else {
      STORE.clients = STORE.clients.filter(c=>c.id!==id);
      saveStore('clients');
    }
    await loadClients();
    showToast('Cliente removido.','success');
  } catch(e){
    console.warn('deleteClient Firestore:', e.message);
    showToast('Falha ao excluir: '+e.message,'error');
  }
}
function exportClientsCSV(){downloadCSV('clientes_bimat.csv',['Nome','CPF','Telefone','Email','Cidade','UF','Origem','Data Cadastro'],clientsFiltered.map(c=>[c.name,c.cpf,c.phone||'',c.email||'',c.city||'',c.state||'',c.origin||'',fmtDate(c.createdAt)]));}
function openClientDetail(id){
  const c=STORE.clients.find(x=>x.id===id); if(!c)return;
  window._detailClientId=id;
  document.getElementById('cd-title').textContent=c.name;
  document.getElementById('cd-personal').innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13.5px">${irow('CPF',c.cpf)}${irow('RG',c.rg)}${irow('WhatsApp',c.phone)}${irow('E-mail',c.email)}${irow('Cidade/UF',(c.city||'')+'/'+(c.state||''))}${irow('Origem',c.origin)}${irow('NB INSS',c.nb)}</div>${c.obs?`<div style="margin-top:12px;padding:10px;background:var(--cream);border-radius:8px;font-size:13px;color:var(--muted)">${c.obs}</div>`:''}`;
  const notes=STORE.audit.filter(a=>a.entityId===id&&a.action==='note').reverse();
  document.getElementById('cd-timeline').innerHTML=notes.length?notes.map(a=>`<li><div class="timeline-dot"></div><div class="timeline-date">${fmtDate(a.at)}</div><div class="timeline-text">${a.desc}</div><div class="timeline-user">${a.user||'Sistema'}</div></li>`).join(''):'<li><div class="timeline-dot"></div><div class="timeline-text" style="color:var(--muted)">Sem anota√ß√µes ainda</div></li>';
  document.getElementById('cd-proposals').innerHTML=STORE.proposals.filter(p=>p.clientId===id).map(p=>`<div style="padding:10px;background:var(--cream);border-radius:8px;margin-bottom:8px;font-size:13px"><div style="font-weight:600;color:var(--navy)">${p.service}</div><div style="display:flex;justify-content:space-between;margin-top:4px">${statusBadgeHtml(p.status)}<span style="font-weight:600;color:var(--green)">R$ ${fmt(p.value)}</span></div></div>`).join('')||'<p style="font-size:13px;color:var(--muted)">Nenhuma proposta</p>';
  document.getElementById('cd-processes').innerHTML=STORE.processes.filter(p=>p.clientId===id).map(p=>`<div style="padding:10px;background:var(--cream);border-radius:8px;margin-bottom:8px;font-size:13px"><div style="font-weight:600;color:var(--navy)">${p.type}</div><div style="display:flex;justify-content:space-between;margin-top:4px"><span class="badge badge-${procStatusColor(p.status)}">${p.status}</span><span style="color:var(--muted)">${p.protocol||'‚Äî'}</span></div></div>`).join('')||'<p style="font-size:13px;color:var(--muted)">Nenhum processo</p>';
  const parc=STORE.parcelas.filter(p=>p.clientId===id);
  const paid=parc.filter(p=>p.status==='Paga').reduce((s,p)=>s+p.value,0);
  const open=parc.filter(p=>p.status!=='Paga'&&p.status!=='Cancelada').reduce((s,p)=>s+p.value,0);
  document.getElementById('cd-financial').innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div style="background:var(--green-bg);padding:12px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:var(--green)">R$ ${fmt(paid)}</div><div style="font-size:12px;color:var(--green)">Recebido</div></div><div style="background:var(--amber-bg);padding:12px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:var(--amber)">R$ ${fmt(open)}</div><div style="font-size:12px;color:var(--amber)">Em aberto</div></div></div>`;
  openModal('client-detail-modal');
}
function irow(label,val){return`<div><span style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">${label}</span><div style="font-weight:500">${val||'‚Äî'}</div></div>`;}
function addClientNote(){const el=document.getElementById('cd-new-note');const note=el.value.trim();if(!note)return;auditLog('client',window._detailClientId,'note',note);el.value='';openClientDetail(window._detailClientId);showToast('Anota√ß√£o adicionada','success');}
function editClientFromDetail(){closeModal('client-detail-modal');setTimeout(()=>openClientModal(window._detailClientId),100);}
function newProposalForClient(){closeModal('client-detail-modal');setTimeout(()=>{navigate('proposals');openProposalModal();document.getElementById('prop-client').value=window._detailClientId;},200);}

// =================== FUNNEL ===================
const FUNNEL_STAGES=['Lead novo','Em atendimento','Aguardando documentos','An√°lise t√©cnica','Proposta enviada','Proposta aprovada','Contrato assinado','Processo protocolado','Indeferido','Deferido','Encerrado'];
async function loadFunnel(){
  try{ await ensureProposalsLoaded(); }catch(e){ console.warn('loadFunnel Firestore:', e.message); }

  document.getElementById('kanban-board').innerHTML=FUNNEL_STAGES.map(stage=>{
    const cards=STORE.proposals.filter(p=>p.stage===stage);
    return`<div class="kanban-col"><div class="kanban-col-header"><span class="kanban-col-title">${stage}</span><span class="kanban-col-count">${cards.length}</span></div><div class="kanban-cards">${cards.map(p=>`<div class="kanban-card" onclick="openProposalModal('${p.id}')"><div class="kanban-card-name">${p.clientName}</div><div class="kanban-card-service">${p.service}</div><div class="kanban-card-meta"><span class="kanban-card-value">R$ ${fmt(p.value)}</span><span class="kanban-card-date">${fmtDate(p.createdAt)}</span></div>${statusBadgeHtml(p.status)}</div>`).join('')}</div><button class="kanban-add" onclick="openProposalModalWithStage('${stage}')">+ Adicionar</button></div>`;
  }).join('');
}
function openProposalModalWithStage(stage){openProposalModal();setTimeout(()=>document.getElementById('prop-stage').value=stage,50);}

// =================== PROPOSALS ===================
let proposalsPage=1,proposalsFiltered=[];
async function loadProposals(){
  try{ await ensureProposalsLoaded(); }catch(e){ console.warn('loadProposals Firestore:', e.message); }
  proposalsFiltered=[...STORE.proposals];
  renderProposalsTable();
}
function filterProposals(v){v=(v||'').toLowerCase();proposalsFiltered=STORE.proposals.filter(p=>p.clientName.toLowerCase().includes(v)||p.service.toLowerCase().includes(v));proposalsPage=1;renderProposalsTable();}
function filterProposalsByStatus(v){proposalsFiltered=v?STORE.proposals.filter(p=>p.status===v):[...STORE.proposals];proposalsPage=1;renderProposalsTable();}
function renderProposalsTable(){
  const paged=paginate(proposalsFiltered,proposalsPage,10);
  document.getElementById('proposals-tbody').innerHTML=paged.data.map(p=>`<tr>
    <td class="td-muted">#${p.id.slice(-4).toUpperCase()}</td>
    <td class="td-name">${p.clientName}</td>
    <td>${p.service}</td>
    <td style="font-weight:600;color:var(--green)">R$ ${fmt(p.value)}</td>
    <td class="td-muted">${paymentLabel(p.payment,p.nParcelas)}</td>
    <td>${statusBadgeHtml(p.status)}</td>
    <td class="td-muted">${fmtDate(p.createdAt)}</td>
    <td><div class="td-actions">
      <div class="td-btn" onclick="openProposalModal('${p.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
      ${p.status!=='aprovada'?`<div class="td-btn" style="color:var(--green);border-color:rgba(13,155,90,.3)" onclick="quickApproveProposal('${p.id}')" title="Aprovar">‚úì</div>`:''}
      ${p.status==='aprovada'?`<div class="td-btn" onclick="openContractForProposal('${p.id}')" title="Ver Contrato"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg></div>`:''}
      <div class="td-btn danger" onclick="deleteProposal('${p.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
    </div></td>
  </tr>`).join('')||'<tr><td colspan="8"><div class="empty-state"><h3>Nenhuma proposta</h3><button class="btn btn-navy" onclick="openProposalModal()">Nova Proposta</button></div></td></tr>';
  document.getElementById('proposals-pagination').innerHTML=renderPagination(paged,proposalsPage,'setProposalsPage');
}
function setProposalsPage(p){proposalsPage=p;renderProposalsTable();}
function openProposalModal(id){
  const p=id?STORE.proposals.find(x=>x.id===id):null;
  document.getElementById('proposal-modal-title').textContent=id?'Editar Proposta':'Nova Proposta';
  document.getElementById('prop-id').value=id||'';
  document.getElementById('prop-client').innerHTML='<option value="">Selecione o cliente...</option>'+STORE.clients.map(c=>`<option value="${c.id}"${p&&p.clientId===c.id?' selected':''}>${c.name}</option>`).join('');
  if(p){
    document.getElementById('prop-service').value=p.service||'';
    document.getElementById('prop-scope').value=p.scope||'';
    document.getElementById('prop-value').value=p.value||'';
    document.getElementById('prop-payment').value=p.payment||'avista';
    document.getElementById('prop-n-parcelas').value=p.nParcelas||1;
    document.getElementById('prop-entrada').value=p.entrada||0;
    document.getElementById('prop-date').value=p.date||'';
    document.getElementById('prop-expiry').value=p.expiry||'';
    document.getElementById('prop-status').value=p.status||'rascunho';
    document.getElementById('prop-stage').value=p.stage||'Lead novo';
    document.getElementById('prop-obs').value=p.obs||'';
    document.getElementById('btn-approve-proposal').style.display=p.status!=='aprovada'?'flex':'none';
  } else {
    ['service','scope','value','obs'].forEach(f=>document.getElementById('prop-'+f).value='');
    document.getElementById('prop-date').value=today();
    document.getElementById('prop-payment').value='avista';
    document.getElementById('prop-n-parcelas').value=1;
    document.getElementById('prop-status').value='rascunho';
    document.getElementById('prop-stage').value='Lead novo';
    document.getElementById('btn-approve-proposal').style.display='none';
  }
  calcParcelas(); openModal('proposal-modal');
}
function calcParcelas(){
  const value=parseFloat(document.getElementById('prop-value').value)||0;
  const payment=document.getElementById('prop-payment').value;
  const n=parseInt(document.getElementById('prop-n-parcelas').value)||1;
  const entrada=parseFloat(document.getElementById('prop-entrada').value)||0;
  document.getElementById('prop-parcelas-field').style.display=payment==='avista'?'none':'block';
  document.getElementById('prop-entrada-field').style.display=payment==='entrada'?'block':'none';
  if(!value){document.getElementById('prop-parcelas-preview').style.display='none';return;}
  document.getElementById('prop-parcelas-preview').style.display='block';
  let html='';
  if(payment==='avista')html=`<span style="color:var(--green);font-weight:600">‚úì Pagamento √∫nico: R$ ${fmt(value)}</span>`;
  else if(payment==='parcelado'){const vp=value/n;html=Array.from({length:n},(_,i)=>`<div>${i+1}/${n}: <strong>R$ ${fmt(vp)}</strong></div>`).join('');}
  else{const vp=n>0?(value-entrada)/n:0;html=`<div>Entrada: <strong>R$ ${fmt(entrada)}</strong></div>`+Array.from({length:n},(_,i)=>`<div>${i+1}/${n}: <strong>R$ ${fmt(vp)}</strong></div>`).join('');}
  document.getElementById('prop-parcelas-list').innerHTML=html;
}
async function saveProposal(){
  const id=document.getElementById('prop-id').value||'p'+Date.now();
  const clientId=document.getElementById('prop-client').value;
  const service=document.getElementById('prop-service').value;
  const value=parseFloat(document.getElementById('prop-value').value)||0;
  if(!clientId||!service||!value){showToast('Cliente, servi√ßo e valor s√£o obrigat√≥rios','error');return;}
  const client=STORE.clients.find(c=>c.id===clientId);
  const existing = STORE.proposals.find(x=>x.id===id);
  const prop={
    id,
    clientId,
    clientName:client?.name||'‚Äî',
    service,
    scope:ge('prop-scope'),
    value,
    payment:ge('prop-payment'),
    nParcelas:parseInt(ge('prop-n-parcelas'))||1,
    entrada:parseFloat(ge('prop-entrada'))||0,
    date:ge('prop-date'),
    expiry:ge('prop-expiry'),
    status:ge('prop-status'),
    stage:ge('prop-stage'),
    obs:ge('prop-obs'),
    createdAt: existing?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  try{
    if (isFirestoreReady()){
      await fsProposals_upsert(prop);
      await ensureProposalsLoaded();
    } else {
      upsert(STORE.proposals,prop); saveStore('proposals');
    }
  }catch(e){
    console.warn('saveProposal Firestore:', e.message);
    // fallback local
    upsert(STORE.proposals,prop); saveStore('proposals');
  }

  auditLog('proposal',id,'save',prop.clientName+' ‚Äî '+service);
  closeModal('proposal-modal');
  await loadProposals();
  if(document.getElementById('section-funnel').classList.contains('active')) await loadFunnel();
  if(document.getElementById('section-dashboard').classList.contains('active')) await loadDashboard();
  showToast('Proposta salva!','success');
}
function approveProposal(){const id=document.getElementById('prop-id').value;if(id){quickApproveProposal(id,true);}}
function quickApproveProposal(id,fromModal){
  const p=STORE.proposals.find(x=>x.id===id); if(!p)return;
  if(!confirm(`Aprovar proposta de ${p.clientName}?
Valor: R$ ${fmt(p.value)}

Ser√£o gerados automaticamente:
‚Ä¢ Contrato vers√£o 1
‚Ä¢ Parcelas no Financeiro`))return;
  p.status='aprovada'; p.stage='Proposta aprovada'; p.approvedAt=new Date().toISOString(); saveStore('proposals');
  generateContract(p); generateParcelas(p);
  if(fromModal)closeModal('proposal-modal');
  loadProposals(); loadFinancial(); if(document.getElementById('section-funnel').classList.contains('active'))loadFunnel();
  showToast('Proposta aprovada! Contrato e parcelas gerados.','success');
}
function deleteProposal(id){if(!confirm('Excluir proposta?'))return;STORE.proposals=STORE.proposals.filter(p=>p.id!==id);saveStore('proposals');loadProposals();showToast('Proposta removida.','success');}
function paymentLabel(payment,n){if(payment==='avista')return'√Ä vista';if(payment==='parcelado')return`${n}x`;return`Entrada + ${n}x`;}

// =================== CONTRACTS ===================
function loadContracts(){
  document.getElementById('contracts-tbody').innerHTML=STORE.contracts.length?STORE.contracts.map(c=>`<tr>
    <td class="td-muted">#${c.id.slice(-4).toUpperCase()}</td>
    <td class="td-name">${c.clientName}</td><td>${c.service}</td>
    <td><span class="badge badge-navy">v${c.version}</span></td>
    <td><span class="badge badge-${c.signed?'green':'amber'}">${c.signed?'Assinado':'Pendente'}</span></td>
    <td class="td-muted">${fmtDate(c.createdAt)}</td>
    <td><div class="td-actions">
      <div class="td-btn" onclick="openContractView('${c.id}')" title="Visualizar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <div class="td-btn" onclick="downloadContractPDFById('${c.id}')" title="PDF"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
      <div class="td-btn ${c.signed?'':'hover'}" onclick="toggleContractSigned('${c.id}')" title="Marcar assinado" style="${c.signed?'color:var(--green);border-color:rgba(13,155,90,.4)':''}">‚úì</div>
    </div></td>
  </tr>`).join(''):'<tr><td colspan="7"><div class="empty-state"><h3>Nenhum contrato gerado</h3><p>Aprove uma proposta para gerar contratos automaticamente</p></div></td></tr>';
  loadTemplates();
}
function loadTemplates(){
  document.getElementById('templates-grid').innerHTML=STORE.templates.map(t=>`<div class="card" style="padding:20px"><div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:6px">${t.name}</div><span class="badge badge-navy">${t.service}</span><div style="display:flex;gap:8px;margin-top:14px"><button class="btn btn-outline btn-sm" onclick="openTemplateModal('${t.id}')">Editar</button><button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}')">Excluir</button></div></div>`).join('')+`<div style="border:2px dashed var(--border);border-radius:var(--r-lg);padding:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;min-height:120px" onclick="openTemplateModal()"><div style="text-align:center;color:var(--muted);font-size:13px">+ Novo Template</div></div>`;
}
function getDefaultContractContent(){return`CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS\n\nCL√ÅUSULA 1 ‚Äì DAS PARTES\nCONTRATADA: BIMAT Solu√ß√µes Jur√≠dicas.\nCONTRATANTE: {{CLIENTE_NOME}}, CPF {{CLIENTE_CPF}}, residente em {{CLIENTE_ENDERECO}}.\n\nCL√ÅUSULA 2 ‚Äì DO OBJETO\nA CONTRATADA realizar√° {{SERVICO}} perante o INSS.\n\nCL√ÅUSULA 3 ‚Äì DA REMUNERA√á√ÉO\nValor: {{VALOR_TOTAL}} ‚Äî {{FORMA_PAGAMENTO}}.\n\nCL√ÅUSULA 4 ‚Äì DO FORO\nForo de S√£o Paulo/SP.\n\nS√£o Paulo, {{DATA_HOJE}}.`;}
async function generateContract(proposal){
  const template=STORE.templates[0]; const client=STORE.clients.find(c=>c.id===proposal.clientId);
  const addr=[client?.street,client?.number,client?.neighborhood,client?.city+'/'+(client?.state||'SP')].filter(Boolean).join(', ')||'‚Äî';
  const raw=(template?.content||getDefaultContractContent()).replace(/\\n/g,'\n');
  const contractContent=raw.replace(/{{CLIENTE_NOME}}/g,client?.name||'‚Äî').replace(/{{CLIENTE_CPF}}/g,client?.cpf||'‚Äî').replace(/{{CLIENTE_ENDERECO}}/g,addr).replace(/{{SERVICO}}/g,proposal.service).replace(/{{VALOR_TOTAL}}/g,'R$ '+fmt(proposal.value)).replace(/{{FORMA_PAGAMENTO}}/g,paymentLabel(proposal.payment,proposal.nParcelas)).replace(/{{DATA_HOJE}}/g,new Date().toLocaleDateString('pt-BR'));
  const prev=STORE.contracts.find(c=>c.proposalId===proposal.id); const version=prev?prev.version+1:1;
  const contract={id:'ct'+Date.now(),proposalId:proposal.id,clientId:proposal.clientId,clientName:proposal.clientName,service:proposal.service,version,content:contractContent,signed:false,createdAt:new Date().toISOString()};
  try{
    if(isFirestoreReady()){ await fsContracts_upsert(contract); }
    else { saveStore('contracts'); }
    STORE.contracts.unshift(contract);
    localStorage.setItem('bimat_contracts', JSON.stringify(STORE.contracts));
    auditLog('contract', contract.id, 'create', contract.clientName+' ‚Äî '+contract.service+' v'+version);
  }catch(e){ console.warn('generateContract Firestore:', e.message); showToast('Erro ao salvar contrato: '+e.message,'error'); }
  return contract;
}
function openContractView(id){
  const c=STORE.contracts.find(x=>x.id===id); if(!c)return;
  window._viewContractId=id;
  document.getElementById('contract-view-title').textContent=`Contrato ‚Äî ${c.clientName} (v${c.version})`;
  const lines=c.content.split('\n');
  document.getElementById('contract-preview-content').innerHTML=`<div class="cp-header"><div class="cp-logo-text">BIMAT</div><div class="cp-subtitle">Solu√ß√µes Jur√≠dicas</div></div><div class="cp-title">CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS</div>${lines.map(l=>!l.trim()?'<br>':l.startsWith('CL√ÅUSULA')||l.startsWith('CONTRAT')||l.startsWith('OUTORG')?`<span class="cp-clause">${l}</span>`:`<p>${l}</p>`).join('')}<div class="cp-sign"><div class="sign-block"><div class="sign-line"></div><div class="sign-name">BIMAT Solu√ß√µes Jur√≠dicas</div><div class="sign-role">CONTRATADA</div></div><div class="sign-block"><div class="sign-line"></div><div class="sign-name">${c.clientName}</div><div class="sign-role">CONTRATANTE</div></div></div>`;
  openModal('contract-view-modal');
}
async function openContractForProposal(proposalId){
  const c=STORE.contracts.find(x=>x.proposalId===proposalId);
  if(c){navigate('contracts');setTimeout(()=>openContractView(c.id),100);}
  else{const p=STORE.proposals.find(x=>x.id===proposalId);if(p){await generateContract(p);navigate('contracts');setTimeout(()=>openContractView(STORE.contracts[0]?.id),100);}}
}
async function toggleContractSigned(id){
  const c=STORE.contracts.find(x=>x.id===id); if(!c)return;
  c.signed=!c.signed;
  try{
    if(isFirestoreReady()){ await fsContracts_upsert(c); }
    else { saveStore('contracts'); }
    localStorage.setItem('bimat_contracts', JSON.stringify(STORE.contracts));
  }catch(e){ c.signed=!c.signed; showToast('Erro: '+e.message,'error'); return; }
  loadContracts(); showToast(c.signed?'Marcado como assinado':'Assinatura removida','success');
}
async function regenerateContract(){
  const id=window._viewContractId; const c=STORE.contracts.find(x=>x.id===id);
  if(c){const p=STORE.proposals.find(x=>x.id===c.proposalId);if(p){closeModal('contract-view-modal');await generateContract(p);loadContracts();showToast('Nova vers√£o gerada!','success');}}
}
function downloadContractPDF(){downloadContractPDFById(window._viewContractId);}
function downloadContractPDFById(id){const c=STORE.contracts.find(x=>x.id===id);if(c)genContractPDF(c);}
function genContractPDF(contract){
  if(!window.jspdf){showToast('Biblioteca PDF n√£o carregada','error');return;}
  const{jsPDF}=window.jspdf; const doc=new jsPDF('p','mm','a4');
  doc.setFillColor(11,61,107); doc.rect(0,0,210,22,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(255,255,255); doc.text('BIMAT',15,14);
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.text('Solu√ß√µes Jur√≠dicas',43,14);
  doc.text('Contrato v'+contract.version+' | '+new Date().toLocaleDateString('pt-BR'),210-15,14,{align:'right'});
  let y=35; doc.setTextColor(11,61,107); doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS',105,y,{align:'center'}); y+=10;
  doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(28,42,58);
  contract.content.split('\n').forEach(line=>{
    if(y>270){doc.addPage();y=25;}
    if(!line.trim()){y+=3;return;}
    if(line.startsWith('CL√ÅUSULA')||line.startsWith('OUTORG')||line.startsWith('CONTRAT')){doc.setFont('helvetica','bold');doc.setTextColor(11,61,107);}
    else{doc.setFont('helvetica','normal');doc.setTextColor(28,42,58);}
    const wrapped=doc.splitTextToSize(line,170);
    wrapped.forEach(wl=>{if(y>270){doc.addPage();y=25;}doc.text(wl,20,y);y+=6;});
  });
  y+=10; if(y>250){doc.addPage();y=25;}
  doc.setDrawColor(200,200,200); doc.line(20,y,90,y); doc.line(120,y,190,y); y+=6;
  doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(28,42,58);
  doc.text('BIMAT Solu√ß√µes Jur√≠dicas',55,y,{align:'center'}); doc.text(contract.clientName,155,y,{align:'center'}); y+=4;
  doc.setFont('helvetica','normal'); doc.setTextColor(90,106,122); doc.text('CONTRATADA',55,y,{align:'center'}); doc.text('CONTRATANTE',155,y,{align:'center'});
  doc.setFontSize(8); doc.text('BIMAT Solu√ß√µes Jur√≠dicas ‚Äî bimat.com.br ‚Äî Gerado em '+new Date().toLocaleDateString('pt-BR'),105,290,{align:'center'});
  doc.save('contrato_'+(contract.clientName.replace(/\s+/g,'_'))+'_v'+contract.version+'.pdf');
  showToast('PDF gerado com sucesso!','success');
}
function openTemplateModal(id){
  const t=id?STORE.templates.find(x=>x.id===id):null;
  document.getElementById('tmpl-name').value=t?.name||'';
  document.getElementById('tmpl-service').value=t?.service||'Assessoria INSS';
  document.getElementById('tmpl-content').value=t?.content||getDefaultContractContent();
  document.getElementById('template-modal').dataset.editId=id||'';
  openModal('template-modal');
}
async function saveTemplate(){
  const id=document.getElementById('template-modal').dataset.editId||'tmpl'+Date.now();
  const name=document.getElementById('tmpl-name').value.trim(); if(!name){showToast('Nome √© obrigat√≥rio','error');return;}
  const tmpl={id,name,service:document.getElementById('tmpl-service').value,content:document.getElementById('tmpl-content').value,createdAt:STORE.templates.find(t=>t.id===id)?.createdAt||new Date().toISOString()};
  try{
    if(isFirestoreReady()){ await fsTemplates_upsert(tmpl); }
    else { saveStore('templates'); }
    upsert(STORE.templates, tmpl);
    localStorage.setItem('bimat_templates', JSON.stringify(STORE.templates));
  }catch(e){ showToast('Erro ao salvar template: '+e.message,'error'); return; }
  closeModal('template-modal'); loadTemplates(); showToast('Template salvo!','success');
}
async function deleteTemplate(id){
  if(!confirm('Excluir template?'))return;
  try{
    if(isFirestoreReady()){ await fsTemplates_delete(id); }
    STORE.templates=STORE.templates.filter(t=>t.id!==id);
    localStorage.setItem('bimat_templates', JSON.stringify(STORE.templates));
  }catch(e){ showToast('Erro ao excluir template: '+e.message,'error'); return; }
  loadTemplates();
}
function switchContractTab(tab,btn){['list','templates','docs'].forEach(t=>document.getElementById('contracts-tab-'+t).style.display=t===tab?'block':'none');document.querySelectorAll('#section-contracts .tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');}

// =================== PROCESSES ===================
let processesPage=1,processesFiltered=[];
function loadProcesses(){processesFiltered=[...STORE.processes];renderProcessesTable();loadBadges();}
function filterProcesses(v){v=(v||'').toLowerCase();processesFiltered=STORE.processes.filter(p=>p.clientName.toLowerCase().includes(v)||(p.protocol||'').includes(v));processesPage=1;renderProcessesTable();}
function filterProcessesByStatus(v){processesFiltered=v?STORE.processes.filter(p=>p.status===v):[...STORE.processes];processesPage=1;renderProcessesTable();}
function filterProcessesByType(v){processesFiltered=v?STORE.processes.filter(p=>p.type===v):[...STORE.processes];processesPage=1;renderProcessesTable();}
function renderProcessesTable(){
  const todayIn7=new Date(Date.now()+86400000*7).toISOString().split('T')[0];
  const paged=paginate(processesFiltered,processesPage,10);
  document.getElementById('processes-tbody').innerHTML=paged.data.length?paged.data.map(p=>{
    const urgent=p.deadline&&p.deadline<=todayIn7&&p.status!=='Deferido'&&p.status!=='Encerrado';
    return`<tr${urgent?' style="background:var(--amber-bg)"':''}>
      <td class="td-name">${p.clientName}</td>
      <td style="font-size:13px">${p.type}</td>
      <td class="td-muted">${p.protocol||'‚Äî'}</td>
      <td><span class="badge badge-${procStatusColor(p.status)}">${p.status}</span></td>
      <td class="td-muted">${fmtDate(p.reqDate)}</td>
      <td class="${urgent?'priority-alta':''}">${fmtDate(p.deadline)||'‚Äî'}</td>
      <td class="td-muted">${p.responsible||'‚Äî'}</td>
      <td><div class="td-actions">
        <div class="td-btn" onclick="openProcessModal('${p.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
        <div class="td-btn danger" onclick="deleteProcess('${p.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
      </div></td>
    </tr>`;}).join(''):'<tr><td colspan="8"><div class="empty-state"><h3>Nenhum processo</h3><button class="btn btn-navy" onclick="openProcessModal()">Novo Processo</button></div></td></tr>';
  document.getElementById('processes-pagination').innerHTML=renderPagination(paged,processesPage,'setProcessesPage');
}
function setProcessesPage(p){processesPage=p;renderProcessesTable();}
let tempChecklist=[];
function openProcessModal(id){
  const p=id?STORE.processes.find(x=>x.id===id):null;
  document.getElementById('process-modal-title').textContent=id?'Editar Processo':'Novo Processo INSS';
  document.getElementById('proc-id').value=id||'';
  document.getElementById('proc-client').innerHTML='<option value="">Selecione...</option>'+STORE.clients.map(c=>`<option value="${c.id}"${p&&p.clientId===c.id?' selected':''}>${c.name}</option>`).join('');
  document.getElementById('proc-responsible').innerHTML='<option value="">Selecione...</option>'+STORE.users.map(u=>`<option value="${u.name}"${p&&p.responsible===u.name?' selected':''}>${u.name}</option>`).join('');
  document.getElementById('proc-proposal').innerHTML='<option value="">Nenhuma</option>'+STORE.proposals.map(pr=>`<option value="${pr.id}"${p&&p.proposalId===pr.id?' selected':''}>${pr.clientName} ‚Äî ${pr.service}</option>`).join('');
  if(p){document.getElementById('proc-type').value=p.type||'';document.getElementById('proc-protocol').value=p.protocol||'';document.getElementById('proc-req-date').value=p.reqDate||'';document.getElementById('proc-status').value=p.status||'Em an√°lise';document.getElementById('proc-deadline').value=p.deadline||'';document.getElementById('proc-obs').value=p.obs||'';renderChecklist(p.checklist||[]);}
  else{document.getElementById('proc-protocol').value='';document.getElementById('proc-req-date').value=today();document.getElementById('proc-status').value='Em an√°lise';document.getElementById('proc-deadline').value='';document.getElementById('proc-obs').value='';renderChecklist([{text:'RG/CPF',done:false},{text:'CNIS',done:false},{text:'Comprovante Resid√™ncia',done:false},{text:'Procura√ß√£o Assinada',done:false}]);}
  openModal('process-modal');
}
function renderChecklist(items){tempChecklist=[...items];document.getElementById('proc-checklist-list').innerHTML=items.map((item,i)=>`<li style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><div class="check-box ${item.done?'checked':''}" onclick="toggleCheckItem(${i})">${item.done?'<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div><span style="flex:1;font-size:13.5px">${item.text}</span><button onclick="removeCheckItem(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;line-height:1">&times;</button></li>`).join('');}
function toggleCheckItem(i){tempChecklist[i].done=!tempChecklist[i].done;renderChecklist(tempChecklist);}
function removeCheckItem(i){tempChecklist.splice(i,1);renderChecklist(tempChecklist);}
function addChecklistItem(){const e=document.getElementById('proc-new-check');if(!e.value.trim())return;tempChecklist.push({text:e.value.trim(),done:false});e.value='';renderChecklist(tempChecklist);}
async function saveProcess(){
  const id=document.getElementById('proc-id').value||'pr'+Date.now();
  const clientId=document.getElementById('proc-client').value; if(!clientId){showToast('Selecione o cliente','error');return;}
  const client=STORE.clients.find(c=>c.id===clientId);
  const proc={id,clientId,clientName:client?.name||'‚Äî',type:document.getElementById('proc-type').value,protocol:ge('proc-protocol'),reqDate:ge('proc-req-date'),status:ge('proc-status'),deadline:ge('proc-deadline'),responsible:document.getElementById('proc-responsible').value,proposalId:document.getElementById('proc-proposal').value,obs:ge('proc-obs'),checklist:[...tempChecklist],createdAt:STORE.processes.find(p=>p.id===id)?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()};
  try{
    if(isFirestoreReady()){ await fsProcesses_upsert(proc); }
    else { upsert(STORE.processes,proc); saveStore('processes'); }
    upsert(STORE.processes,proc); localStorage.setItem('bimat_processes',JSON.stringify(STORE.processes));
    auditLog('process',id,'save',proc.clientName+' ‚Äî '+proc.type);
  }catch(e){ showToast('Erro ao salvar processo: '+e.message,'error'); return; }
  closeModal('process-modal'); loadProcesses(); showToast('Processo salvo!','success');
}
async function deleteProcess(id){
  if(!confirm('Excluir processo?'))return;
  try{
    if(isFirestoreReady()){ await fsProcesses_delete(id); }
    STORE.processes=STORE.processes.filter(p=>p.id!==id);
    localStorage.setItem('bimat_processes',JSON.stringify(STORE.processes));
  }catch(e){ showToast('Erro ao excluir: '+e.message,'error'); return; }
  loadProcesses();
}
function procStatusColor(s){const m={'Em an√°lise':'navy','Exig√™ncia':'amber','Per√≠cia':'purple','Deferido':'green','Indeferido':'red','Recurso':'amber','Encerrado':'gray'};return m[s]||'gray';}

// =================== TASKS ===================
let tasksFilter='todas';
function loadTasks(){renderTasksTable();}
function filterTasksByStatus(s,btn){tasksFilter=s;document.querySelectorAll('#section-tasks .tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');renderTasksTable();}
function renderTasksTable(){
  const todayStr=new Date().toISOString().split('T')[0];
  let tasks=[...STORE.tasks];
  if(tasksFilter==='pendente')tasks=tasks.filter(t=>t.status==='pendente'&&t.due>todayStr);
  else if(tasksFilter==='vencida')tasks=tasks.filter(t=>t.status!=='concluida'&&t.due<=todayStr);
  else if(tasksFilter==='concluida')tasks=tasks.filter(t=>t.status==='concluida');
  document.getElementById('tasks-tbody').innerHTML=tasks.length?tasks.map(t=>{
    const overdue=t.status!=='concluida'&&t.due<=todayStr;
    return`<tr${overdue?' style="background:var(--red-bg)"':''}>
      <td><div style="display:flex;align-items:center;gap:10px"><div class="check-box ${t.status==='concluida'?'checked':''}" onclick="toggleTask('${t.id}')">${t.status==='concluida'?'<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div><span style="${t.status==='concluida'?'text-decoration:line-through;color:var(--muted)':'font-weight:500'}">${t.title}</span></div></td>
      <td class="td-muted">${t.clientName||'‚Äî'}</td>
      <td class="td-muted">${t.responsible||'‚Äî'}</td>
      <td><span class="${t.priority==='alta'?'priority-alta':t.priority==='media'?'priority-media':'priority-baixa'}">${t.priority||'m√©dia'}</span></td>
      <td class="${overdue?'priority-alta':''}">${fmtDate(t.due)}</td>
      <td><span class="badge badge-${t.status==='concluida'?'green':overdue?'red':'amber'}">${t.status==='concluida'?'Conclu√≠da':overdue?'Vencida':'Pendente'}</span></td>
      <td><div class="td-actions">
        <div class="td-btn" onclick="openTaskModal('${t.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
        <div class="td-btn danger" onclick="deleteTask('${t.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
      </div></td>
    </tr>`;}).join(''):'<tr><td colspan="7"><div class="empty-state"><h3>Nenhuma tarefa</h3><button class="btn btn-navy" onclick="openTaskModal()">Nova Tarefa</button></div></td></tr>';
}
async function toggleTask(id){const t=STORE.tasks.find(x=>x.id===id);if(t){t.status=t.status==='concluida'?'pendente':'concluida';if(isFirestoreReady()){try{await fsTasks_upsert(t);}catch(e){console.warn(e);}}saveStore('tasks');renderTasksTable();loadBadges();}}
function openTaskModal(id){
  const t=id?STORE.tasks.find(x=>x.id===id):null;
  document.getElementById('task-modal-title').textContent=id?'Editar Tarefa':'Nova Tarefa';
  document.getElementById('task-id').value=id||'';
  document.getElementById('task-responsible').innerHTML='<option value="">Selecione...</option>'+STORE.users.map(u=>`<option value="${u.name}"${t&&t.responsible===u.name?' selected':''}>${u.name}</option>`).join('');
  document.getElementById('task-title').value=t?.title||'';
  document.getElementById('task-priority').value=t?.priority||'media';
  document.getElementById('task-due').value=t?.due||new Date(Date.now()+86400000*3).toISOString().split('T')[0];
  document.getElementById('task-client-name').value=t?.clientName||'';
  document.getElementById('task-desc').value=t?.desc||'';
  openModal('task-modal');
}
async function saveTask(){
  const id=document.getElementById('task-id').value||'t'+Date.now();
  const title=document.getElementById('task-title').value.trim(); if(!title){showToast('T√≠tulo √© obrigat√≥rio','error');return;}
  const task={id,title,responsible:document.getElementById('task-responsible').value,priority:document.getElementById('task-priority').value,due:ge('task-due'),clientName:ge('task-client-name'),desc:ge('task-desc'),status:STORE.tasks.find(t=>t.id===id)?.status||'pendente',createdAt:STORE.tasks.find(t=>t.id===id)?.createdAt||new Date().toISOString()};
  try{
    if(isFirestoreReady()){ await fsTasks_upsert(task); }
    else { upsert(STORE.tasks,task); saveStore('tasks'); }
    upsert(STORE.tasks,task); localStorage.setItem('bimat_tasks',JSON.stringify(STORE.tasks));
  }catch(e){ showToast('Erro ao salvar tarefa: '+e.message,'error'); return; }
  closeModal('task-modal'); loadTasks(); loadBadges(); showToast('Tarefa salva!','success');
}
async function deleteTask(id){
  if(!confirm('Excluir tarefa?'))return;
  try{
    if(isFirestoreReady()){ await fsTasks_delete(id); }
    STORE.tasks=STORE.tasks.filter(t=>t.id!==id);
    localStorage.setItem('bimat_tasks',JSON.stringify(STORE.tasks));
  }catch(e){ showToast('Erro ao excluir: '+e.message,'error'); return; }
  loadTasks(); loadBadges();
}

// =================== FINANCIAL ===================
let parcelasPage=1,parcelasFiltered=[];
async function loadFinancial(){
  try{ await ensureParcelasLoaded(); }catch(e){ console.warn('loadFinancial Firestore:', e.message); }
  parcelasFiltered=[...STORE.parcelas];
  renderFinancialStats();
  renderParcelasTable();
}
function renderFinancialStats(){
  const total=STORE.parcelas.reduce((s,p)=>s+p.value,0);
  const rec=STORE.parcelas.filter(p=>p.status==='Paga').reduce((s,p)=>s+p.value,0);
  const ab=STORE.parcelas.filter(p=>p.status==='Aberta').reduce((s,p)=>s+p.value,0);
  const at=STORE.parcelas.filter(p=>p.status==='Atrasada').reduce((s,p)=>s+p.value,0);
  document.getElementById('fin-stats').innerHTML=
    statCard('navy','Total Emitido','R$&nbsp;'+fmt(total),'','<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>')+
    statCard('green','Recebido','R$&nbsp;'+fmt(rec),'','<polyline points="20 6 9 17 4 12"/>')+
    statCard('amber','Em Aberto','R$&nbsp;'+fmt(ab),'','<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>')+
    statCard('red','Atrasado','R$&nbsp;'+fmt(at),STORE.parcelas.filter(p=>p.status==='Atrasada').length+' parcelas','<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>');
}
function filterParcelas(v){v=(v||'').toLowerCase();parcelasFiltered=STORE.parcelas.filter(p=>p.clientName.toLowerCase().includes(v)||p.service.toLowerCase().includes(v));parcelasPage=1;renderParcelasTable();}
function filterParcelasByStatus(v){parcelasFiltered=v?STORE.parcelas.filter(p=>p.status===v):[...STORE.parcelas];parcelasPage=1;renderParcelasTable();}
function filterParcelasByMonth(v){if(!v){parcelasFiltered=[...STORE.parcelas];renderParcelasTable();return;}const[yr,mo]=v.split('-');parcelasFiltered=STORE.parcelas.filter(p=>{const d=new Date(p.due+'T12:00');return d.getFullYear()==yr&&(d.getMonth()+1)==mo;});parcelasPage=1;renderParcelasTable();}
function renderParcelasTable(){
  const todayStr=new Date().toISOString().split('T')[0];
  STORE.parcelas.forEach(p=>{if(p.status==='Aberta'&&p.due<todayStr)p.status='Atrasada';});
  const paged=paginate(parcelasFiltered,parcelasPage,10);
  const cmap={Paga:'green',Aberta:'amber',Atrasada:'red',Cancelada:'gray',Renegociada:'purple'};
  document.getElementById('parcelas-tbody').innerHTML=paged.data.length?paged.data.map(p=>`<tr>
    <td class="td-name">${p.clientName}</td>
    <td style="font-size:13px">${p.service}</td>
    <td class="td-muted">${p.parcela}</td>
    <td style="font-weight:600">R$ ${fmt(p.value)}</td>
    <td class="${p.status==='Atrasada'?'priority-alta':''}">${fmtDate(p.due)}</td>
    <td><span class="badge badge-${cmap[p.status]||'gray'}">${p.status}</span></td>
    <td class="td-muted">${p.paidAt?fmtDate(p.paidAt)+(p.payMethod?' ‚Äî '+p.payMethod:''):'‚Äî'}</td>
    <td><div class="td-actions">
      ${p.status!=='Paga'&&p.status!=='Cancelada'?`<div class="td-btn" style="color:var(--green)" onclick="openPaymentModal('${p.id}')" title="Registrar pagamento">‚úì</div>`:''}
      ${p.status!=='Paga'&&p.status!=='Cancelada'&&p.status!=='Renegociada'?`<div class="td-btn" onclick="openRenegotiationModal('${p.id}')" title="Renegociar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg></div>`:''}
      ${p.status!=='Paga'?`<div class="td-btn danger" onclick="cancelParcela('${p.id}')">‚úï</div>`:''}
    </div></td>
  </tr>`).join(''):'<tr><td colspan="8"><div class="empty-state"><h3>Nenhuma parcela</h3><p>Aprove uma proposta para gerar parcelas</p></div></td></tr>';
  document.getElementById('parcelas-pagination').innerHTML=renderPagination(paged,parcelasPage,'setParcelasPage');
}
function setParcelasPage(p){parcelasPage=p;renderParcelasTable();}
async function generateParcelas(proposal){
  // Gera lista local (para render imediato) e grava no Firestore quando poss√≠vel
  const base=new Date();
  const parcelas=[];
  if(proposal.payment==='avista'){
    parcelas.push(mkParcela(proposal,'1/1',proposal.value,addMonths(base,1)));
  } else if(proposal.payment==='parcelado'){
    const vp=proposal.value/proposal.nParcelas;
    for(let i=0;i<proposal.nParcelas;i++){
      parcelas.push(mkParcela(proposal,`${i+1}/${proposal.nParcelas}`,vp,addMonths(base,i+1)));
    }
  } else { // entrada + parcelas
    const rest=proposal.value-(proposal.entrada||0);
    const vp=proposal.nParcelas>0?rest/proposal.nParcelas:rest;
    if((proposal.entrada||0)>0) parcelas.push(mkParcela(proposal,'Entrada',proposal.entrada,addMonths(base,0)));
    for(let i=0;i<proposal.nParcelas;i++){
      parcelas.push(mkParcela(proposal,`${i+1}/${proposal.nParcelas}`,vp,addMonths(base,i+1)));
    }
  }

  // Atualiza cache local
  STORE.parcelas = STORE.parcelas.filter(p=>p.proposalId!==proposal.id);
  STORE.parcelas.push(...parcelas);
  saveStore('parcelas');

  // Firestore: substitui parcelas da proposta por estas (evita duplica√ß√£o)
  try{
    if (isFirestoreReady()){
      await fsParcelas_deleteByProposal(proposal.id);
      await fsParcelas_upsertMany(parcelas);
      await ensureParcelasLoaded();
    }
  }catch(e){
    console.warn('generateParcelas Firestore:', e.message);
  }
}
function mkParcela(prop,label,value,due){return{id:'pa'+Date.now()+Math.random().toString(36).slice(2,5),proposalId:prop.id,clientId:prop.clientId,clientName:prop.clientName,service:prop.service,parcela:label,value:Math.round(value*100)/100,due:due.toISOString().split('T')[0],status:'Aberta',createdAt:new Date().toISOString()};}
function addMonths(d,m){const nd=new Date(d);nd.setMonth(nd.getMonth()+m);return nd;}
function openPaymentModal(id){
  const p=STORE.parcelas.find(x=>x.id===id); if(!p)return;
  document.getElementById('pay-parcela-id').value=id;
  document.getElementById('pay-info').innerHTML=`<strong>${p.clientName}</strong> ‚Äî ${p.service}<br>Parcela: <strong>${p.parcela}</strong> | Valor: <strong>R$ ${fmt(p.value)}</strong><br>Vencimento: ${fmtDate(p.due)}`;
  document.getElementById('pay-date').value=today();
  document.getElementById('pay-amount').value=p.value;
  document.getElementById('pay-obs').value='';
  openModal('payment-modal');
}
async function savePayment(){
  const id=ge('pay-parcela-id'); const p=STORE.parcelas.find(x=>x.id===id); if(!p)return;
  p.status='Paga'; p.paidAt=ge('pay-date'); p.payMethod=document.getElementById('pay-method').value;
  p.paidAmount=parseFloat(ge('pay-amount'))||p.value; p.payObs=ge('pay-obs');
  try{
    if(isFirestoreReady()){ await fsParcelas_upsert(p); }
    else { saveStore('parcelas'); }
    localStorage.setItem('bimat_parcelas', JSON.stringify(STORE.parcelas));
    auditLog('parcela',id,'payment',p.clientName+' '+p.parcela);
  }catch(e){ showToast('Erro ao salvar pagamento: '+e.message,'error'); return; }
  closeModal('payment-modal'); loadFinancial(); renderFinancialStats(); showToast('Pagamento registrado!','success');
}
async function cancelParcela(id){
  if(!confirm('Cancelar parcela?'))return;
  const p=STORE.parcelas.find(x=>x.id===id); if(!p)return;
  p.status='Cancelada';
  try{
    if(isFirestoreReady()){ await fsParcelas_upsert(p); }
    else { saveStore('parcelas'); }
    localStorage.setItem('bimat_parcelas', JSON.stringify(STORE.parcelas));
    auditLog('parcela',id,'cancel',p.clientName+' '+p.parcela);
  }catch(e){ p.status='Aberta'; showToast('Erro ao cancelar: '+e.message,'error'); return; }
  loadFinancial(); showToast('Parcela cancelada.','success');
}
function openRenegotiationModal(id){
  const p=STORE.parcelas.find(x=>x.id===id); if(!p)return;
  document.getElementById('reneg-parcela-id').value=id;
  document.getElementById('reneg-value').value=p.value;
  document.getElementById('reneg-n').value=2;
  document.getElementById('reneg-first-due').value=addMonths(new Date(),1).toISOString().split('T')[0];
  document.getElementById('reneg-reason').value='';
  openModal('renegotiation-modal');
}
async function saveRenegotiation(){
  const id=ge('reneg-parcela-id'); const value=parseFloat(ge('reneg-value'))||0; const n=parseInt(ge('reneg-n'))||1;
  const firstDue=new Date(ge('reneg-first-due')+'T12:00'); const reason=ge('reneg-reason');
  if(!value||!n){showToast('Preencha todos os campos','error');return;}
  const orig=STORE.parcelas.find(x=>x.id===id); if(!orig)return;
  const prevStatus=orig.status;
  orig.status='Renegociada';
  const vp=value/n;
  const novas=[];
  for(let i=0;i<n;i++){
    novas.push({
      id:'pa'+Date.now()+i,proposalId:orig.proposalId,clientId:orig.clientId,
      clientName:orig.clientName,service:orig.service,parcela:`RN${i+1}/${n}`,
      value:Math.round(vp*100)/100,due:addMonths(firstDue,i).toISOString().split('T')[0],
      status:'Aberta',isRenegotiation:true,renegReason:reason,
      renegOriginalId:id,createdAt:new Date().toISOString()
    });
  }
  try{
    if(isFirestoreReady()){
      await fsParcelas_upsert(orig);
      await fsParcelas_upsertMany(novas);
    } else {
      saveStore('parcelas');
    }
    novas.forEach(p=>STORE.parcelas.push(p));
    localStorage.setItem('bimat_parcelas', JSON.stringify(STORE.parcelas));
    auditLog('parcela',id,'renegotiation',orig.clientName+' ‚Äî '+(reason||'sem motivo'));
  }catch(e){
    orig.status=prevStatus;
    showToast('Erro ao renegociar: '+e.message,'error'); return;
  }
  closeModal('renegotiation-modal'); loadFinancial(); showToast('Renegocia√ß√£o criada!','success');
}
function switchFinTab(tab,btn){['receivable','renegotiation'].forEach(t=>document.getElementById('fin-tab-'+t).style.display=t===tab?'block':'none');document.querySelectorAll('#section-financial .tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');}
function exportFinancialCSV(){downloadCSV('financeiro_bimat.csv',['Cliente','Servi√ßo','Parcela','Valor','Vencimento','Status','Pago em','Forma'],parcelasFiltered.map(p=>[p.clientName,p.service,p.parcela,p.value,p.due,p.status,p.paidAt||'',p.payMethod||'']));}

// =================== REPORTS ===================
const REPORT_COLUMNS={proposals:['clientName','service','value','payment','status','stage','createdAt'],parcelas:['clientName','service','parcela','value','due','status','paidAt','payMethod'],processes:['clientName','type','protocol','status','reqDate','deadline','responsible'],clients:['name','cpf','phone','email','city','state','origin','createdAt'],tasks:['title','clientName','responsible','priority','due','status']};
const REPORT_LABELS={clientName:'Cliente',service:'Servi√ßo',value:'Valor (R$)',payment:'Pagamento',status:'Status',stage:'Etapa',createdAt:'Criado em',parcela:'Parcela',due:'Vencimento',paidAt:'Pago em',payMethod:'Forma Pgto',type:'Tipo',protocol:'Protocolo',reqDate:'Requerimento',deadline:'Prazo',responsible:'Respons√°vel',name:'Nome',cpf:'CPF',phone:'Telefone',email:'E-mail',city:'Cidade',state:'UF',origin:'Origem',title:'Tarefa',priority:'Prioridade'};
let reportData=[],selectedReportCols=[];
function initReports(){
  updateReportColumns();
  const now=new Date();
  document.getElementById('report-date-from').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  document.getElementById('report-date-to').value=now.toISOString().split('T')[0];
}
function updateReportColumns(){
  const src=document.querySelector('input[name="report-source"]:checked')?.value||'proposals';
  const cols=REPORT_COLUMNS[src]||[]; selectedReportCols=[...cols];
  document.getElementById('report-columns').innerHTML=cols.map(c=>`<div class="filter-chip selected" data-col="${c}" onclick="toggleReportCol(this,'${c}')">${REPORT_LABELS[c]||c}</div>`).join('');
}
function toggleReportCol(el,col){el.classList.toggle('selected');if(el.classList.contains('selected')){if(!selectedReportCols.includes(col))selectedReportCols.push(col);}else selectedReportCols=selectedReportCols.filter(c=>c!==col);}
function runReport(){
  const src=document.querySelector('input[name="report-source"]:checked')?.value||'proposals';
  const from=ge('report-date-from'); const to=ge('report-date-to'); const statusF=ge('report-filter-status');
  let data=[...STORE[src]||[]];
  if(from)data=data.filter(r=>{const d=r.createdAt||r.due||r.reqDate||'';return!d||d>=from;});
  if(to)data=data.filter(r=>{const d=r.createdAt||r.due||r.reqDate||'';return!d||d<=to;});
  if(statusF)data=data.filter(r=>r.status===statusF);
  reportData=data; const cols=selectedReportCols.length?selectedReportCols:REPORT_COLUMNS[src];
  document.getElementById('report-results').style.display='block';
  document.getElementById('report-results-title').textContent=`${data.length} registros ‚Äî ${src}`;
  document.getElementById('report-table-head').innerHTML=`<tr>${cols.map(c=>`<th>${REPORT_LABELS[c]||c}</th>`).join('')}</tr>`;
  document.getElementById('report-table-body').innerHTML=data.slice(0,100).map(row=>`<tr>${cols.map(c=>{let v=row[c]||'‚Äî';if(c==='value')v='R$ '+fmt(v);else if(['createdAt','paidAt','due','reqDate','deadline'].includes(c))v=fmtDate(v);else if(c==='status')v=statusBadgeHtml(v);return`<td>${v}</td>`;}).join('')}</tr>`).join('');
  const totalValue=cols.includes('value')?reportData.reduce((s,r)=>s+(parseFloat(r.value)||0),0):0;
  document.getElementById('report-summary').innerHTML=(totalValue?`<strong>Total:</strong> R$ ${fmt(totalValue)} &nbsp;|&nbsp; `:'')+'<strong>Registros:</strong> '+data.length;
  showToast('Relat√≥rio gerado!','success');
}
function exportReportCSV(){
  const src=document.querySelector('input[name="report-source"]:checked')?.value||'proposals';
  const cols=selectedReportCols.length?selectedReportCols:REPORT_COLUMNS[src];
  downloadCSV('relatorio_bimat.csv',cols.map(c=>REPORT_LABELS[c]||c),reportData.map(row=>cols.map(c=>{let v=row[c]||'';if(['createdAt','paidAt','due','reqDate','deadline'].includes(c))v=fmtDate(v);return v;})));
}
function exportReportPDF(){
  if(!window.jspdf){showToast('Biblioteca PDF n√£o carregada','error');return;}
  const{jsPDF}=window.jspdf; const doc=new jsPDF('l','mm','a4');
  const src=document.querySelector('input[name="report-source"]:checked')?.value||'proposals';
  const cols=selectedReportCols.length?selectedReportCols:REPORT_COLUMNS[src];
  doc.setFillColor(11,61,107); doc.rect(0,0,297,20,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(255,255,255); doc.text('BIMAT ‚Äî Relat√≥rio: '+capitalize(src),14,13);
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.text(new Date().toLocaleDateString('pt-BR'),297-14,13,{align:'right'});
  const headers=[cols.map(c=>REPORT_LABELS[c]||c)];
  const rows=reportData.slice(0,200).map(row=>cols.map(c=>{let v=row[c]||'‚Äî';if(c==='value')v='R$ '+fmt(v);else if(['createdAt','paidAt','due','reqDate','deadline'].includes(c))v=fmtDate(v);return String(v).replace(/<[^>]+>/g,'');}));
  doc.autoTable({head:headers,body:rows,startY:24,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[11,61,107],textColor:255,fontStyle:'bold'},alternateRowStyles:{fillColor:[247,244,239]}});
  doc.save('relatorio_bimat.pdf'); showToast('PDF exportado!','success');
}
function saveReportModel(){showToast('Modelo salvo (funcionalidade dispon√≠vel com Firebase)','success');}

// =================== USERS ===================
const MODULE_KEYS   = ['clients','proposals','contracts','processes','financial','tasks','reports','users'];
const MODULE_LABELS = ['Clientes','Propostas','Contratos','Processos INSS','Financeiro','Tarefas','Relat√≥rios','Usu√°rios'];
const ROLE_KEYS     = ['admin','gestor','operacional','comercial','financeiro','leitura'];
const PERM_ACTIONS  = ['V','C','D']; // Visualizar, Criar/Editar, Excluir

async function loadUsers(){
  if(isFirestoreReady()){
    try{ STORE.users = await fsUsers_list(); localStorage.setItem('bimat_users',JSON.stringify(STORE.users)); }
    catch(e){ console.warn('loadUsers Firestore:',e.message); }
  }
  document.getElementById('users-tbody').innerHTML=STORE.users.map(u=>`<tr>
    <td><div style="display:flex;align-items:center;gap:10px"><div class="user-avatar" style="width:32px;height:32px;font-size:12px">${u.name.charAt(0).toUpperCase()}</div><div><div style="font-weight:600;color:var(--navy)">${u.name}</div><div style="font-size:12px;color:var(--muted)">${u.uid||''}</div></div></div></td>
    <td class="td-muted">${u.email}</td>
    <td>${roleBadge(u.role)}</td>
    <td class="td-muted">${fmtDate(u.lastAccess)||'‚Äî'}</td>
    <td><span class="badge badge-${u.status==='ativo'?'green':'red'}">${u.status||'ativo'}</span></td>
    <td><div class="td-actions">
      <div class="td-btn" onclick="openEditUserModal('${u.id}')" title="Editar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
      <div class="td-btn" onclick="toggleUserStatus('${u.id}')" title="${u.status==='ativo'?'Desativar':'Ativar'}">‚ü≥</div>
      <div class="td-btn danger" onclick="deleteUser('${u.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
    </div></td>
  </tr>`).join('');
  renderPermissionsTable();
}

function renderPermissionsTable(){
  const perms = getPermissions();
  // Header
  const modeNote = CUSTOM_PERMISSIONS ? '<span style="font-size:11px;color:var(--amber);margin-left:8px">‚úèÔ∏è Personalizado</span>' : '<span style="font-size:11px;color:var(--muted);margin-left:8px">Padr√£o</span>';
  const cardHeader = document.querySelector('#section-users .card:last-child .card-header h3');
  if(cardHeader) cardHeader.innerHTML = 'Matriz de Permiss√µes por Perfil' + modeNote;

  document.getElementById('perms-tbody').innerHTML = MODULE_KEYS.map((mod,mi)=>`
    <tr>
      <td style="font-weight:500">${MODULE_LABELS[mi]}</td>
      ${ROLE_KEYS.map(role=>{
        const rp = perms[role]||{};
        const mp = rp[mod]||[];
        return '<td style="text-align:center">'+PERM_ACTIONS.map(a=>`
          <label title="${a==='V'?'Visualizar':a==='C'?'Criar/Editar':'Excluir'}" style="cursor:${role==='admin'?'default':'pointer'};margin:0 2px">
            <input type="checkbox" data-role="${role}" data-mod="${mod}" data-action="${a}" 
              ${mp.includes(a)?'checked':''} ${role==='admin'?'disabled':''}
              onchange="onPermChange(this)" style="cursor:${role==='admin'?'default':'pointer'}">
            <span style="font-size:10px;color:var(--muted)">${a}</span>
          </label>`).join('')+'</td>';
      }).join('')}
    </tr>`).join('');
}

function onPermChange(el){
  const perms = JSON.parse(JSON.stringify(getPermissions()));
  const role=el.dataset.role, mod=el.dataset.mod, action=el.dataset.action;
  if(!perms[role]) perms[role]={};
  if(!perms[role][mod]) perms[role][mod]=[];
  if(el.checked){ if(!perms[role][mod].includes(action)) perms[role][mod].push(action); }
  else { perms[role][mod]=perms[role][mod].filter(a=>a!==action); }
  // Se remover V, remove C e D tamb√©m
  if(action==='V'&&!el.checked){ perms[role][mod]=[]; document.querySelectorAll(`[data-role="${role}"][data-mod="${mod}"]`).forEach(x=>x.checked=false); }
  savePermissionsToFirestore(perms).then(()=>{ applyPermissionsToNav(); showToast('Permiss√£o atualizada!','success'); });
}

function resetPermissions(){
  if(!confirm('Resetar permiss√µes para o padr√£o?')) return;
  CUSTOM_PERMISSIONS=null; localStorage.removeItem('bimat_permissions');
  if(isFirestoreReady()) db.collection('config').doc('permissions').delete().catch(()=>{});
  applyPermissionsToNav(); loadUsers(); showToast('Permiss√µes resetadas!','success');
}

function openUserModal(){
  document.getElementById('user-modal-title').textContent='Novo Usu√°rio';
  document.getElementById('u-id').value='';
  document.getElementById('u-name').value='';
  document.getElementById('u-email').value='';
  document.getElementById('u-email').disabled=false;
  document.getElementById('u-role').value='operacional';
  document.getElementById('u-pass').value='';
  document.getElementById('u-pass-group').style.display='';
  openModal('user-modal');
}
function openEditUserModal(id){
  const u=STORE.users.find(x=>x.id===id); if(!u)return;
  document.getElementById('user-modal-title').textContent='Editar Usu√°rio';
  document.getElementById('u-id').value=u.id;
  document.getElementById('u-name').value=u.name;
  document.getElementById('u-email').value=u.email;
  document.getElementById('u-email').disabled=true;
  document.getElementById('u-role').value=u.role||'operacional';
  document.getElementById('u-pass').value='';
  document.getElementById('u-pass-group').style.display='none';
  openModal('user-modal');
}
async function saveUser(){
  const editId=document.getElementById('u-id').value;
  const name=document.getElementById('u-name').value.trim();
  const email=document.getElementById('u-email').value.trim();
  const role=document.getElementById('u-role').value;
  const pass=document.getElementById('u-pass').value;
  if(!name||!email){showToast('Nome e e-mail s√£o obrigat√≥rios','error');return;}

  if(editId){
    // Editar usu√°rio existente
    const u=STORE.users.find(x=>x.id===editId);
    if(u){ u.name=name; u.role=role; }
    try{
      if(isFirestoreReady()){ await fsUsers_upsert({...u,name,role}); }
      else { saveStore('users'); }
      upsert(STORE.users,{...u,name,role});
      localStorage.setItem('bimat_users',JSON.stringify(STORE.users));
    }catch(e){ showToast('Erro: '+e.message,'error'); return; }
    closeModal('user-modal'); loadUsers(); applyPermissionsToNav(); showToast('Usu√°rio atualizado!','success');
    return;
  }

  // Criar novo usu√°rio
  if(!pass||pass.length<6){showToast('Senha deve ter ao menos 6 caracteres','error');return;}
  const now=new Date().toISOString();

  if(isFirestoreReady()&&auth){
    // Cria via Firebase Auth usando app secund√°ria para n√£o deslogar o admin
    try{
      let secondaryApp;
      try{
        secondaryApp=firebase.app('secondary');
      }catch(e){
        secondaryApp=firebase.initializeApp(FIREBASE_CONFIG,'secondary');
      }
      const secondaryAuth=secondaryApp.auth();
      const uc=await secondaryAuth.createUserWithEmailAndPassword(email,pass);
      const uid=uc.user.uid;
      await secondaryAuth.signOut();
      const newUser={id:uid,uid,name,email,role,status:'ativo',createdAt:now,lastAccess:now};
      await fsUsers_upsert(newUser);
      STORE.users.push(newUser);
      localStorage.setItem('bimat_users',JSON.stringify(STORE.users));
      closeModal('user-modal'); loadUsers(); showToast('Usu√°rio criado no Firebase Auth + Firestore!','success');
    }catch(e){
      if(e.code==='auth/email-already-in-use'){
        // Usu√°rio j√° existe no Auth, s√≥ salva no Firestore
        const uid='u'+Date.now();
        const newUser={id:uid,name,email,role,status:'ativo',createdAt:now,lastAccess:now};
        await fsUsers_upsert(newUser);
        STORE.users.push(newUser);
        localStorage.setItem('bimat_users',JSON.stringify(STORE.users));
        closeModal('user-modal'); loadUsers(); showToast('E-mail j√° existe no Auth. Dados salvos no Firestore.','warning');
      } else { showToast('Erro ao criar usu√°rio: '+e.message,'error'); }
    }
  } else {
    // Modo demo / offline
    const uid='u'+Date.now();
    const newUser={id:uid,name,email,role,status:'ativo',createdAt:now,lastAccess:now};
    STORE.users.push(newUser);
    saveStore('users');
    closeModal('user-modal'); loadUsers(); showToast('Usu√°rio criado localmente (modo demo).','success');
  }
}
async function toggleUserStatus(id){
  const u=STORE.users.find(x=>x.id===id); if(!u)return;
  u.status=u.status==='ativo'?'inativo':'ativo';
  try{
    if(isFirestoreReady()){ await fsUsers_upsert(u); }
    else { saveStore('users'); }
    localStorage.setItem('bimat_users',JSON.stringify(STORE.users));
  }catch(e){ showToast('Erro: '+e.message,'error'); return; }
  loadUsers();
}
async function deleteUser(id){
  if(id===currentUser?.uid||STORE.users.find(x=>x.id===id)?.email===currentUser?.email){showToast('N√£o √© poss√≠vel excluir o pr√≥prio usu√°rio.','error');return;}
  if(!confirm('Excluir usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.'))return;
  try{
    if(isFirestoreReady()){ await fsUsers_delete(id); }
    STORE.users=STORE.users.filter(u=>u.id!==id);
    localStorage.setItem('bimat_users',JSON.stringify(STORE.users));
  }catch(e){ showToast('Erro ao excluir: '+e.message,'error'); return; }
  loadUsers(); showToast('Usu√°rio removido.','success');
}
function roleBadge(role){const m={admin:'navy',gestor:'gold',operacional:'purple',comercial:'green',financeiro:'amber',leitura:'gray'};return`<span class="badge badge-${m[role]||'gray'}">${capitalize(role)}</span>`;}

// =================== SETTINGS ===================
function loadSettings(){
  document.getElementById('profile-email').value=currentUserData?.email||'';
  document.getElementById('profile-name').value=currentUserData?.name||'';
  document.getElementById('fb-api-key').value=localStorage.getItem('fb-api-key')||'';
  document.getElementById('fb-auth-domain').value=localStorage.getItem('fb-auth-domain')||'';
  document.getElementById('fb-project-id').value=localStorage.getItem('fb-project-id')||'';
  document.getElementById('fb-storage-bucket').value=localStorage.getItem('fb-storage-bucket')||'';
  document.getElementById('fb-app-id').value=localStorage.getItem('fb-app-id')||'';
  updateFirebaseStatus();
}
function saveFirebaseConfig(){['api-key','auth-domain','project-id','storage-bucket','app-id'].forEach(k=>{const v=document.getElementById('fb-'+k).value.trim();if(v)localStorage.setItem('fb-'+k,v);});showToast('Configura√ß√£o salva! Recarregue a p√°gina.','success');}
function updateProfile(){const name=document.getElementById('profile-name').value.trim();if(!name){showToast('Nome obrigat√≥rio','error');return;}if(currentUserData)currentUserData.name=name;updateUserUI();showToast('Perfil atualizado!','success');}

// =================== NOTIFICATIONS ===================
function loadBadges(){
  const todayStr=new Date().toISOString().split('T')[0];
  const urgentProc=STORE.processes.filter(p=>p.status==='Exig√™ncia'||(p.deadline&&p.deadline<=new Date(Date.now()+86400000*7).toISOString().split('T')[0]&&!['Deferido','Encerrado'].includes(p.status))).length;
  const urgentTasks=STORE.tasks.filter(t=>t.status!=='concluida'&&t.due<=todayStr).length;
  const bpEl=document.getElementById('badge-processes'); const btEl=document.getElementById('badge-tasks');
  if(bpEl){bpEl.textContent=urgentProc;bpEl.style.display=urgentProc?'':'none';}
  if(btEl){btEl.textContent=urgentTasks;btEl.style.display=urgentTasks?'':'none';}
  document.getElementById('notif-dot').style.display=(urgentProc||urgentTasks)?'':'none';
}
function toggleNotifications(){
  const panel=document.getElementById('notif-panel');
  if(panel.style.display==='none'||!panel.style.display){loadNotifications();panel.style.display='block';setTimeout(()=>document.addEventListener('click',closeNotifOutside),0);}
  else panel.style.display='none';
}
function closeNotifOutside(e){const panel=document.getElementById('notif-panel');if(panel&&!panel.contains(e.target)&&!e.target.closest('.topbar-btn')){panel.style.display='none';document.removeEventListener('click',closeNotifOutside);}}
function loadNotifications(){
  const todayStr=new Date().toISOString().split('T')[0];
  const notifs=[];
  STORE.processes.filter(p=>p.status==='Exig√™ncia').forEach(p=>notifs.push({title:'‚ö†Ô∏è Exig√™ncia INSS',desc:p.clientName+' ‚Äî '+p.type,time:p.deadline?fmtDate(p.deadline):'Pendente'}));
  STORE.parcelas.filter(p=>p.status==='Atrasada').forEach(p=>notifs.push({title:'üí∞ Parcela atrasada',desc:p.clientName+' ‚Äî '+p.parcela,time:fmtDate(p.due)}));
  STORE.tasks.filter(t=>t.status!=='concluida'&&t.due<=todayStr).forEach(t=>notifs.push({title:'üìã Tarefa vencida',desc:t.title,time:fmtDate(t.due)}));
  document.getElementById('notif-list').innerHTML=notifs.length?notifs.map(n=>`<div class="notif-item"><div class="notif-item-title">${n.title}</div><div class="notif-item-desc">${n.desc}</div><div class="notif-item-time">${n.time}</div></div>`).join(''):'<div style="padding:20px;text-align:center;font-size:13px;color:var(--muted)">Nenhuma notifica√ß√£o</div>';
}

// =================== GLOBAL SEARCH ===================
function globalSearch(v){
  if(!v||v.length<2)return;
  v=v.toLowerCase();
  const clients=STORE.clients.filter(c=>c.name.toLowerCase().includes(v)||c.cpf.includes(v));
  if(clients.length>0){navigate('clients');setTimeout(()=>filterClients(v),50);}
  else{const procs=STORE.processes.filter(p=>p.clientName.toLowerCase().includes(v)||(p.protocol||'').includes(v));if(procs.length>0){navigate('processes');setTimeout(()=>filterProcesses(v),50);}}
}

// =================== UTILITIES ===================
function openModal(id){document.getElementById(id)?.classList.add('open');}
function closeModal(id){document.getElementById(id)?.classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))closeModal(e.target.id);});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.open').forEach(m=>closeModal(m.id));});
function showToast(msg,type='success'){
  const c=document.getElementById('toast-container'); const t=document.createElement('div');
  t.className='toast '+type;
  const icons={success:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',error:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>'};
  t.innerHTML=(icons[type]||icons.success)+`<span class="toast-msg">${msg}</span><button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
  c.appendChild(t); setTimeout(()=>{if(t.parentElement)t.remove();},5000);
}
function fmt(n){return(parseFloat(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){if(!d)return'‚Äî';try{const dt=new Date(d+'T12:00:00');return isNaN(dt)?d:dt.toLocaleDateString('pt-BR');}catch(e){return d;}}
function today(){return new Date().toISOString().split('T')[0];}
function capitalize(s){return s?s.charAt(0).toUpperCase()+s.slice(1):'';}
function originBadge(o){const m={WhatsApp:'green',Google:'navy',Instagram:'purple',Indica√ß√£o:'gold',Outro:'gray'};return m[o]||'gray';}
function statusBadgeHtml(s){const m={rascunho:'gray',enviada:'navy',aprovada:'green',cancelada:'red','Lead novo':'gray','Em atendimento':'amber','Proposta enviada':'navy','Proposta aprovada':'green','Contrato assinado':'green','Processo protocolado':'purple','Deferido':'green','Indeferido':'red','Encerrado':'gray'};return`<span class="badge badge-${m[s]||'gray'}">${s}</span>`;}
function paginate(arr,page,perPage=10){const total=arr.length;const totalPages=Math.ceil(total/perPage)||1;const start=(page-1)*perPage;return{data:arr.slice(start,start+perPage),total,totalPages,page};}
function renderPagination(paged,currentPage,fnName){
  if(paged.totalPages<=1)return'';
  const btns=[];
  if(currentPage>1)btns.push(`<button class="pg-btn" onclick="${fnName}(${currentPage-1})">‚Äπ</button>`);
  for(let i=1;i<=Math.min(paged.totalPages,7);i++)btns.push(`<button class="pg-btn ${i===currentPage?'active':''}" onclick="${fnName}(${i})">${i}</button>`);
  if(currentPage<paged.totalPages)btns.push(`<button class="pg-btn" onclick="${fnName}(${currentPage+1})">‚Ä∫</button>`);
  return`<div class="pagination-info">Mostrando ${Math.min(paged.total,(currentPage-1)*10+1)}‚Äì${Math.min(paged.total,currentPage*10)} de ${paged.total}</div><div class="pagination-btns">${btns.join('')}</div>`;
}
function upsert(arr,item){const idx=arr.findIndex(x=>x.id===item.id);if(idx>=0)arr[idx]=item;else arr.unshift(item);}
function auditLog(entity,entityId,action,desc){STORE.audit.push({entity,entityId,action,desc,at:new Date().toISOString(),user:currentUserData?.name||'Sistema'});if(STORE.audit.length>500)STORE.audit=STORE.audit.slice(-300);saveStore('audit');}
function downloadCSV(filename,headers,rows){const csv=[headers,...rows].map(r=>r.map(v=>'"'+(String(v||'').replace(/"/g,'""'))+'"').join(',')).join('\n');const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();}
function maskCPF(el){let v=el.value.replace(/\D/g,'');if(v.length>11)v=v.slice(0,11);v=v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})\.(\d{3})(\d)/,'$1.$2.$3').replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/,'$1.$2.$3-$4');el.value=v;}
function maskCEP(el){let v=el.value.replace(/\D/g,'');if(v.length>8)v=v.slice(0,8);v=v.replace(/(\d{5})(\d)/,'$1-$2');el.value=v;}
async function fetchCEP(){
  const cep=(document.getElementById('c-cep')?.value||'').replace(/\D/g,'');
  if(cep.length!==8)return;
  try{const r=await fetch('https://viacep.com.br/ws/'+cep+'/json/');const d=await r.json();if(!d.erro){document.getElementById('c-street').value=d.logradouro||'';document.getElementById('c-neighborhood').value=d.bairro||'';document.getElementById('c-city').value=d.localidade||'';document.getElementById('c-state').value=d.uf||'SP';}}catch(e){}
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('collapsed');}

// =================== INIT ===================
document.addEventListener('DOMContentLoaded',async ()=>{
  initFirebase();
  const saved=sessionStorage.getItem('bimat_session');
  if(saved){
    try{
      currentUser=JSON.parse(saved);
      let userData=STORE.users.find(x=>x.email===currentUser.email||x.id===currentUser.uid);
      if(!userData && db && auth){
        try{
          const snap=await db.collection('users').doc(currentUser.uid||currentUser.email).get();
          if(snap.exists) userData=snap.data();
        }catch(e){}
      }
      currentUserData=userData||{id:currentUser.uid||'admin',name:'Admin BIMAT',email:currentUser.email,role:'admin'};
      onLogin();
    }catch(e){
      console.warn('Session restore:',e);
      showLoginPage();
    }
  } else {
    showLoginPage();
  }
  setTimeout(updateFirebaseStatus,500);
});

function showLoginPage(){
  document.getElementById('app').style.display='none';
  document.getElementById('login-page').style.display='flex';
  document.getElementById('login-page').classList.add('active');
}

function updateFirebaseStatus(){
  const el=document.getElementById('fb-status');
  if(!el)return;
  if(USE_DEMO){
    el.innerHTML='<span style="color:var(--amber)">‚ö†Ô∏è Modo Demo ‚Äî dados salvos apenas localmente (localStorage)</span>';
  } else if(db){
    el.innerHTML='<span style="color:var(--green)">‚úÖ Conectado ao Firebase ‚Äî dados sincronizados em nuvem</span>';
  } else {
    el.innerHTML='<span style="color:var(--red)">‚ùå Firebase configurado mas n√£o inicializado ‚Äî verifique as credenciais</span>';
  }
}
document.addEventListener('DOMContentLoaded',async ()=>{
  initFirebase();
  const saved=sessionStorage.getItem('bimat_session');
  if(saved){
    try{
      currentUser=JSON.parse(saved);
      let userData=STORE.users.find(x=>x.email===currentUser.email||x.id===currentUser.uid);
      if(!userData && db && auth){
        try{
          const snap=await db.collection('users').doc(currentUser.uid||currentUser.email).get();
          if(snap.exists) userData=snap.data();
        }catch(e){}
      }
      currentUserData=userData||{id:currentUser.uid||'admin',name:'Admin BIMAT',email:currentUser.email,role:'admin'};
      onLogin();
    }catch(e){
      console.warn('Session restore:',e);
      showLoginPage();
    }
  } else {
    showLoginPage();
  }
  setTimeout(updateFirebaseStatus,500);
});
</script>
</body>
</html>
